<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="iExbroKtO4ZRq3ZjUsyY8JJowXvx-yHOy4yQq0iS6vY" />
    <title>PinkDays</title>
    
    <!-- PWA and Mobile App Configuration -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ff5c7c">

    <!-- Add to Homescreen & Favicon Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="pinkdays_logo.png">
    <link rel="icon" type="image/png" sizes="32x32" href="pinkdays_logo.png">
    <link rel="icon" type="image/png" sizes="16x16" href="pinkdays_logo.png">
    <link rel="shortcut icon" href="pinkdays_logo.png">

    <!-- Apple-specific meta tags for Add to Homescreen -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PinkDays">
    <link rel="apple-touch-icon" href="pinkdays_logo.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        .main-gradient-text {
            background: -webkit-linear-gradient(45deg, #ff5c7c,#ff8ca6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .main-gradient-bg {
            background: linear-gradient(to right, #ff8ca6, #ff5c7c);
        }
        .main-gradient-box {
            background: linear-gradient(to right, #ff5c7c, #fa4366);
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .day {
            transition: all 0.2s ease-in-out;
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        .flow-light { background-color: #ffb8c9; color: #9d174d; }
        .flow-medium { background-color: #ff8ca6; color: #fff; }
        .flow-heavy { background-color: #ff5c7c; color: #fff; }
        .predicted-day { background-color: #fff0f3; border: 1px dashed #ffb8c9; }
        .fertile-day { background-color: #cffafe; color: #164e63; }
        .day.today { font-weight: bold; color: #1f2937; box-shadow: 0 0 0 2px #ff8ca6; }
        .day:not(.disabled):hover { background-color: #e5e7eb; }
        .disabled { color: #9ca3af; }
        .sunday-text { color: #ef4444; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); display: flex; justify-content: center; align-items: center; z-index: 50; transition: opacity 0.2s ease-in-out; }
        .legend-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .tab-btn.active { background-color: #ff5c7c; color: white; }
        .hidden { display: none !important; }
        .month-picker-btn { width: 100%; padding: 0.75rem; border-radius: 0.5rem; font-weight: 500; transition: background-color 0.15s; }
        .month-picker-btn:hover { background-color: #f3f4f6; }
        .month-picker-btn.active { background-color: #ff5c7c; color: white; }
        .auth-form-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 1rem; }
        
        /* Buttery Smooth Transition classes */
        .screen-transition {
            transition: opacity 0.5s ease-in-out;
        }
        .is-transparent {
            opacity: 0;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- =========== AUTHENTICATION SCREEN =========== -->
    <div id="auth-container" class="auth-form-container screen-transition is-transparent hidden">
        <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-xl">
            <div class="text-center mb-8">
                <div class="flex justify-center items-baseline gap-2">
                    <img src="pinkdays_transparentlogo.png" alt="Logo" class="w-12 h-12 relative top-1" onerror="this.style.display='none'">
                    <div class="pb-2"> 
                         <h1 class="text-5xl font-bold main-gradient-text">PinkDays</h1>
                    </div>
                </div>
                <p class="text-gray-500 mt-2">A simple and private period tracker.</p>
            </div>
            
            <div class="space-y-4">
                <input id="email-input" type="email" placeholder="Email" class="w-full px-4 py-3 bg-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300 transition">
                <div class="relative">
                    <input id="password-input" type="password" placeholder="Password" class="w-full px-4 py-3 bg-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300 transition">
                    <button id="password-toggle" class="absolute inset-y-0 right-0 flex items-center px-4 text-gray-500">
                        <i id="eye-open-icon" class="fas fa-eye"></i>
                        <i id="eye-closed-icon" class="fas fa-eye-slash hidden"></i>
                    </button>
                </div>
                <div class="flex justify-end items-center">
                    <a id="forgot-password-link" href="#" class="text-sm text-pink-500 hover:underline">Forgot Password?</a>
                </div>
            </div>

            <div id="auth-error-message" class="text-red-500 text-sm mt-4 text-center h-4"></div>

            <div class="flex items-center gap-2 mt-4">
                <button id="signin-btn" class="w-full py-3 text-white font-semibold rounded-lg shadow-md hover:opacity-90 transition main-gradient-box flex justify-center items-center h-12">
                    <span class="button-text">Sign In</span>
                    <i class="fas fa-spinner fa-spin hidden"></i>
                </button>
                <button id="signup-btn" class="w-full py-3 text-gray-700 bg-gray-200 font-semibold rounded-lg hover:bg-gray-300 transition flex justify-center items-center h-12">
                    <span class="button-text">Sign Up</span>
                    <i class="fas fa-spinner fa-spin hidden"></i>
                </button>
            </div>
            
            <div class="flex items-center my-6">
                <hr class="flex-grow border-t border-gray-300">
                <span class="px-3 text-gray-500 text-sm">OR</span>
                <hr class="flex-grow border-t border-gray-300">
            </div>

            <button id="google-signin-btn" class="w-full flex items-center justify-center gap-3 py-3 border border-gray-300 rounded-lg hover:bg-gray-100 transition h-12">
                <img src="https://upload.wikimedia.org/wikipedia/commons/3/3c/Google_Favicon_2025.svg" alt="Google Icon" class="w-5 h-5 button-icon">
                <span class="button-text">Continue with Google</span>
                <i class="fas fa-spinner fa-spin hidden"></i>
            </button>

            <button id="offline-btn" class="w-full text-center mt-3 py-3 text-gray-700 bg-gray-100 font-semibold rounded-lg hover:bg-gray-200 transition">
                Continue Offline
                <span class="block text-xs font-normal text-gray-500">(Saves data only on this device)</span>
            </button>

             <div class="text-center mt-8">
                <a href="mailto:arunthomas04042001@gmail.com" class="inline-flex items-center gap-2 text-sm text-gray-500 hover:text-pink-500 transition-colors">
                    <i class="fas fa-envelope"></i>
                    Reach out to the developer
                </a>
            </div>
        </div>
    </div>

    <!-- =========== MAIN APPLICATION =========== -->
    <div id="app-wrapper" class="hidden screen-transition">
        <div id="app-container" class="max-w-xl mx-auto p-4">
            <header class="relative text-center my-6 flex justify-center items-center">
                <div class="flex items-baseline gap-2">
                    <img src="pinkdays_transparentlogo.png" alt="PinkDays Logo" class="w-10 h-10 relative top-1" onerror="this.style.display='none'">
                    <h1 class="text-4xl font-bold main-gradient-text">PinkDays</h1>
                </div>
                <div id="user-controls" class="absolute right-0"></div>
            </header>

            <nav class="flex justify-center bg-gray-200 rounded-lg p-1 mb-6">
                <button data-tab="stats" class="tab-btn flex-1 py-2 px-4 rounded-lg font-semibold transition-colors active">Stats</button>
                <button data-tab="calendar" class="tab-btn flex-1 py-2 px-4 rounded-lg font-semibold transition-colors">Calendar</button>
                <button data-tab="settings" class="tab-btn flex-1 py-2 px-4 rounded-lg font-semibold transition-colors">Settings</button>
            </nav>

            <div id="tab-content">
                <!-- Stats Tab -->
                <div id="stats-tab" class="tab-pane space-y-6">
                    <section class="main-gradient-box text-white p-6 rounded-2xl shadow-lg text-center">
                        <h3 class="text-lg font-semibold mb-2 opacity-90">Period In</h3>
                        <p id="next-period-countdown" class="text-5xl font-bold">--</p>
                        <p id="next-period-date" class="text-lg opacity-80 h-5 mt-2"></p>
                    </section>
                    <section class="bg-white p-6 rounded-2xl shadow-lg text-center">
                        <h3 class="text-lg font-semibold mb-2 text-gray-700">Fertile During</h3>
                        <p id="next-fertile-window" class="text-3xl font-bold main-gradient-text">--</p>
                    </section>
                    <section class="bg-white p-6 rounded-2xl shadow-lg">
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div>
                                <p class="text-gray-600">Avg. Cycle Length</p>
                                <p id="avg-cycle-length" class="text-2xl font-bold main-gradient-text">--</p>
                            </div>
                            <div>
                                <p class="text-gray-600">Avg. Period Length</p>
                                <p id="avg-period-length" class="text-2xl font-bold main-gradient-text">--</p>
                            </div>
                        </div>
                    </section>
                    
                    <div id="detailed-analysis" class="hidden space-y-6">
                        <section class="bg-white p-6 rounded-2xl shadow-lg">
                            <h3 class="text-lg font-semibold mb-4 text-center">Average Flow Analysis</h3>
                            <div id="flow-analysis" class="text-center text-gray-600">
                            </div>
                        </section>
                        <section class="bg-white p-6 rounded-2xl shadow-lg">
                            <h3 class="text-lg font-semibold mb-4 text-center">Period History</h3>
                            <ul id="period-history-list" class="space-y-3">
                            </ul>
                        </section>
                    </div>
                    <div class="text-center mt-6">
                        <button id="show-analysis-btn" class="inline-flex items-center gap-2 px-6 py-3 main-gradient-box text-white font-semibold rounded-full shadow-sm hover:opacity-90 transition-opacity">
                            Detailed analysis <span id="analysis-arrow" class="text-2xl leading-none font-light">+</span>
                        </button>
                    </div>
                </div>

                <!-- Calendar Tab -->
                <div id="calendar-tab" class="tab-pane hidden">
                    <main class="bg-white p-6 rounded-2xl shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-100">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                            </button>
                            <h2 id="month-year" class="text-xl font-semibold main-gradient-text cursor-pointer hover:underline"></h2>
                            <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-100">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </button>
                        </div>
                        <div class="grid grid-cols-7 text-center font-medium text-gray-500 mb-2">
                            <div class="sunday-text">Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                        </div>
                        <div id="calendar-grid" class="calendar-grid"></div>
                        <div class="mt-4 pt-4 border-t flex justify-center items-center gap-4 text-xs text-gray-600">
                            <div class="flex items-center"><span class="legend-dot bg-pink-300"></span>Period</div>
                            <div class="flex items-center"><span class="legend-dot bg-cyan-200"></span>Fertile</div>
                            <div class="flex items-center"><span class="legend-dot predicted-day border border-pink-200"></span>Predicted</div>
                        </div>
                        <div class="text-center mt-4 pt-4 border-t">
                            <button id="log-period-btn" class="w-full main-gradient-box text-white font-bold py-3 px-6 rounded-lg shadow-md hover:opacity-90 transition-opacity">Log New Period</button>
                        </div>
                    </main>
                    <div class="mt-6 p-4 bg-red-100 text-red-800 rounded-lg shadow-sm text-sm border-l-4 border-red-500 text-center">
                        <p class="font-semibold">Disclaimer:</p>
                        <p>All predictions and information in this app are estimates and should not be considered medical advice.</p>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="settings-tab" class="tab-pane hidden">
                    <div class="space-y-6">
                        <section class="bg-white p-6 rounded-2xl shadow-lg">
                            <h3 class="text-xl font-semibold text-center mb-6 main-gradient-text">Backup & Restore</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div class="text-center">
                                    <button id="import-data-btn" class="w-full flex items-center justify-center gap-2 bg-white text-pink-500 font-bold py-3 px-6 rounded-xl shadow-md border-2 border-pink-500 hover:bg-pink-50 transition-colors">
                                        <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg> Import
                                    </button>
                                    <input type="file" id="upload-data-input" class="hidden" accept=".json">
                                </div>
                                <div class="text-center">
                                    <button id="export-data-btn" class="w-full flex items-center justify-center gap-2 main-gradient-box text-white font-bold py-3 px-6 rounded-xl shadow-md hover:opacity-90 transition-opacity">
                                        <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg> Export
                                    </button>
                                </div>
                            </div>
                        </section>
                        
                        <section class="bg-white p-6 rounded-2xl shadow-lg">
                            <h3 class="text-xl font-semibold text-center mb-6 main-gradient-text">Override Average Cycle Length (days)</h3>
                            <div class="space-y-4">
                                <div class="mb-4">
                                    <div class="flex items-center space-x-2">
                                        <input type="number" id="cycle-length-input-settings" class="flex-1 p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-200 focus:border-pink-300 transition-colors" placeholder="e.g. 28">
                                        <button id="save-cycle-override-btn" class="px-6 py-3 main-gradient-box text-white font-semibold rounded-xl shadow-md hover:opacity-90 transition-opacity" aria-label="Save">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17L4 12"/></svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="flex justify-center">
                                    <button id="recalculate-btn-settings" class="text-sm text-pink-600 hover:underline">Auto-calculate from history</button>
                                </div>
                            </div>
                        </section>

                        <section class="bg-white p-6 rounded-2xl shadow-lg text-center">
                            <div>
                                <button id="reset-data-btn" class="w-full bg-red-600 text-white font-bold py-3 px-6 rounded-xl shadow-md hover:bg-red-700 transition-colors">Reset All Data</button>
                            </div>
                        </section>
                    </div>

                    <footer class="text-center py-6 mt-4">
                        <a href="mailto:arunthomas04042001@gmail.com" class="inline-flex items-center gap-2 text-sm text-gray-500 hover:text-pink-500 transition-colors">
                            <i class="fas fa-envelope"></i>
                            Reach out to the developer
                        </a>
                    </footer>
                </div>
            </div>
        </div>
        
        <!-- MODALS -->
        <div id="welcome-modal" class="modal-backdrop hidden"><div class="bg-white p-8 rounded-2xl shadow-2xl w-11/12 max-w-md text-center"><img src="pinkdays_transparentlogo.png" alt="PinkDays Logo" class="w-16 h-16 mx-auto mb-4" onerror="this.style.display='none'"><h2 class="text-2xl font-bold mb-4 main-gradient-text">Welcome to PinkDays!</h2><p class="text-gray-600 mb-6">Here's a quick look at what you can do:</p><ul class="text-left space-y-3 mb-8"><li class="flex items-center"><span class="text-2xl mr-4">🗓️</span><span>Track your period & flow on the <b>Calendar</b>.</span></li><li class="flex items-center"><span class="text-2xl mr-4">📈</span><span>View predictions & history in the <b>Stats</b> tab.</span></li><li class="flex items-center"><span class="text-2xl mr-4">🔮</span><span>See your estimated <b>fertile window</b> automatically.</span></li><li class="flex items-center"><span class="text-2xl mr-4">⚙️</span><span><b>Export</b> or <b>Import</b> your data in Settings.</span></li></ul><button id="close-welcome-btn" class="w-full main-gradient-box text-white font-bold py-3 px-6 rounded-lg shadow-md hover:opacity-90 transition-opacity">Let's Get Started!</button></div></div>
        <div id="log-period-modal" class="modal-backdrop hidden"><div class="bg-white p-6 rounded-2xl shadow-2xl w-11/12 max-w-md"><h2 class="text-2xl font-bold mb-4 text-center main-gradient-text">Log Period</h2><div class="grid grid-cols-2 gap-4 mb-4"><div><label for="start-date-input" class="block text-sm font-medium text-gray-700">Start Date</label><input type="date" id="start-date-input" class="mt-1 w-full p-2 border border-gray-300 rounded-lg"></div><div><label for="end-date-input" class="block text-sm font-medium text-gray-700">End Date</label><input type="date" id="end-date-input" class="mt-1 w-full p-2 border border-gray-300 rounded-lg"></div></div><h3 class="text-md font-semibold text-center mb-2">Daily Flow</h3><div id="daily-flow-container" class="space-y-2 mb-4 max-h-48 overflow-y-auto p-2 bg-gray-50 rounded-lg"></div><div class="flex flex-col gap-2"><button id="save-log-btn" class="w-full main-gradient-box text-white font-bold py-3 px-6 rounded-lg shadow-md hover:opacity-90 transition-opacity">Save</button><button id="cancel-log-btn" class="w-full bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">Cancel</button></div></div></div>
        <div id="month-picker-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 modal-backdrop"><div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-xs"><div class="flex justify-between items-center mb-4"><button id="prev-year-btn" class="p-2 rounded-full hover:bg-gray-200" aria-label="Previous Year"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button><h3 id="picker-year-display" class="text-lg font-semibold text-gray-800">2025</h3><button id="next-year-btn" class="p-2 rounded-full hover:bg-gray-200" aria-label="Next Year"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button></div><div id="month-grid" class="grid grid-cols-4 gap-2"></div><div class="flex justify-end mt-4"><button id="close-month-picker-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Close</button></div></div></div>
        <div id="confirm-modal" class="modal-backdrop hidden"><div class="bg-white p-8 rounded-2xl shadow-2xl w-11/12 max-w-md text-center"><h2 id="confirm-title" class="text-2xl font-bold mb-2"></h2><p id="confirm-message" class="text-gray-600 mb-6"></p><div id="confirm-options-container" class="flex gap-4"></div></div></div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDEK9OgZ0PphoukTJb9uB1J_0de8Dtf0QA",
            authDomain: "pinkdaysaoh.firebaseapp.com",
            projectId: "pinkdaysaoh",
            storageBucket: "pinkdaysaoh.firebasestorage.app",
            messagingSenderId: "16168022769",
            appId: "1:16168022769:web:a7a4daf40c7bf11b56af50"
        };

        // Initialize Firebase
        const firebaseApp = initializeApp(firebaseConfig);
        const auth = getAuth(firebaseApp);
        const db = getFirestore(firebaseApp);

        // --- GLOBAL STATE ---
        let currentUser = null;
        let isOfflineMode = false;

        // --- DOM Elements (Auth) ---
        const authContainer = document.getElementById('auth-container');
        const appWrapper = document.getElementById('app-wrapper');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const signinBtn = document.getElementById('signin-btn');
        const signupBtn = document.getElementById('signup-btn');
        const googleSigninBtn = document.getElementById('google-signin-btn');
        const offlineBtn = document.getElementById('offline-btn');
        const passwordToggle = document.getElementById('password-toggle');
        const eyeOpenIcon = document.getElementById('eye-open-icon');
        const eyeClosedIcon = document.getElementById('eye-closed-icon');
        const userControlsContainer = document.getElementById('user-controls');
        const authErrorMessage = document.getElementById('auth-error-message');
        const forgotPasswordLink = document.getElementById('forgot-password-link');

        // --- Transition Functions ---
        const TRANSITION_DURATION = 500; // Match CSS duration in milliseconds
        function showAuthScreen() {
            appWrapper.classList.add('is-transparent');
            setTimeout(() => {
                appWrapper.classList.add('hidden');
                authContainer.classList.remove('hidden');
                requestAnimationFrame(() => {
                    authContainer.classList.remove('is-transparent');
                });
            }, TRANSITION_DURATION);
        }

        function showAppScreen() {
            authContainer.classList.add('is-transparent');
            setTimeout(() => {
                authContainer.classList.add('hidden');
                appWrapper.classList.remove('hidden');
                requestAnimationFrame(() => {
                    appWrapper.classList.remove('is-transparent');
                });
            }, TRANSITION_DURATION);
        }

        // --- App Logic ---
        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM Elements ---
            var app = {
                tabButtons: document.querySelectorAll('.tab-btn'), tabPanes: document.querySelectorAll('.tab-pane'),
                countdown: document.getElementById('next-period-countdown'), nextDate: document.getElementById('next-period-date'), nextFertileWindow: document.getElementById('next-fertile-window'), avgCycle: document.getElementById('avg-cycle-length'), avgPeriod: document.getElementById('avg-period-length'), flowAnalysis: document.getElementById('flow-analysis'), historyList: document.getElementById('period-history-list'), detailedAnalysis: document.getElementById('detailed-analysis'), showAnalysisBtn: document.getElementById('show-analysis-btn'), analysisArrow: document.getElementById('analysis-arrow'),
                calendarGrid: document.getElementById('calendar-grid'), monthYear: document.getElementById('month-year'), prevBtn: document.getElementById('prev-month-btn'), nextBtn: document.getElementById('next-month-btn'), logPeriodBtn: document.getElementById('log-period-btn'),
                cycleOverrideInput: document.getElementById('cycle-length-input-settings'), saveCycleOverrideBtn: document.getElementById('save-cycle-override-btn'), recalculateBtn: document.getElementById('recalculate-btn-settings'), exportBtn: document.getElementById('export-data-btn'), importBtn: document.getElementById('import-data-btn'), uploadInput: document.getElementById('upload-data-input'), resetBtn: document.getElementById('reset-data-btn'),
                welcomeModal: document.getElementById('welcome-modal'), closeWelcomeBtn: document.getElementById('close-welcome-btn'), logModal: document.getElementById('log-period-modal'), startDateInput: document.getElementById('start-date-input'), endDateInput: document.getElementById('end-date-input'), dailyFlowContainer: document.getElementById('daily-flow-container'), saveLogBtn: document.getElementById('save-log-btn'), cancelLogBtn: document.getElementById('cancel-log-btn'), monthPickerModal: document.getElementById('month-picker-modal'), prevYearBtn: document.getElementById('prev-year-btn'), nextYearBtn: document.getElementById('next-year-btn'), pickerYearDisplay: document.getElementById('picker-year-display'), monthGrid: document.getElementById('month-grid'), closeMonthPickerBtn: document.getElementById('close-month-picker-btn'), confirmModal: document.getElementById('confirm-modal'), confirmTitle: document.getElementById('confirm-title'), confirmMessage: document.getElementById('confirm-message'), confirmOptions: document.getElementById('confirm-options-container')
            };

            // --- State ---
            var currentDate = new Date();
            var pickerYear = new Date().getFullYear();
            var periodData = {
                periods: [],
                cycleLength: 28
            };

            // --- INITIAL APP LOAD ---
            function initializeApp() {
                if (localStorage.getItem('pinkDaysOfflineMode') === 'true') {
                    isOfflineMode = true;
                    currentUser = null;
                    appWrapper.classList.remove('hidden', 'is-transparent');
                    authContainer.classList.add('hidden');
                    loadDataFromLocalStorage();
                    addOfflineExitButton();
                } else {
                    onAuthStateChanged(auth, handleAuthState);
                }
            }

            // --- AUTHENTICATION LOGIC ---
            function setButtonState(button, isLoading) {
                const spinner = button.querySelector('.fa-spinner');
                const text = button.querySelector('.button-text');
                const icon = button.querySelector('.button-icon'); // Specifically for the Google icon

                if (isLoading) {
                    button.disabled = true;
                    button.style.pointerEvents = 'none';
                    if (text) text.classList.add('hidden');
                    if (spinner) spinner.classList.remove('hidden');
                } else {
                    button.disabled = false;
                    button.style.pointerEvents = 'auto';
                    if (text) text.classList.remove('hidden');
                    if (spinner) spinner.classList.add('hidden');
                }
            }

            async function handleAuthState(user) {
                if (user) {
                    currentUser = user;
                    isOfflineMode = false;
                    localStorage.removeItem('pinkDaysOfflineMode');
                    showAppScreen();
                    await loadDataFromFirestore();
                    addLogoutButton();
                } else {
                    currentUser = null;
                    if (!isOfflineMode) {
                        showAuthScreen();
                    }
                    resetAppData();
                    userControlsContainer.innerHTML = '';
                }
            }

            const createExitButton = (id, title) => {
                const button = document.createElement('button');
                button.id = id;
                button.title = title;
                button.className = "p-2 h-10 w-10 flex items-center justify-center text-gray-500 bg-gray-200 rounded-full hover:bg-pink-100 hover:text-pink-500 transition-colors duration-200";
                button.innerHTML = `<i class="fas fa-right-from-bracket"></i>`;
                return button;
            }

            const addLogoutButton = () => {
                userControlsContainer.innerHTML = '';
                const logoutBtn = createExitButton('logout-btn', 'Logout');
                logoutBtn.addEventListener('click', async () => await signOut(auth));
                userControlsContainer.appendChild(logoutBtn);
            };
            
            const addOfflineExitButton = () => {
                userControlsContainer.innerHTML = '';
                const exitBtn = createExitButton('exit-offline-btn', 'Exit Offline Mode');
                exitBtn.addEventListener('click', () => {
                    isOfflineMode = false;
                    localStorage.removeItem('pinkDaysOfflineMode');
                    showAuthScreen();
                });
                userControlsContainer.appendChild(exitBtn);
            };

            const resetAppData = () => {
                periodData = { periods: [], cycleLength: 28 };
                updateAllUI();
            };
            
            const setAuthMessage = (message, isError = true) => {
                authErrorMessage.textContent = message;
                authErrorMessage.className = `text-sm mt-4 text-center h-4 ${isError ? 'text-red-500' : 'text-green-600'}`;
            };

            passwordToggle.addEventListener('click', () => {
                const isPassword = passwordInput.type === 'password';
                passwordInput.type = isPassword ? 'text' : 'password';
                eyeOpenIcon.classList.toggle('hidden');
                eyeClosedIcon.classList.toggle('hidden');
            });
            
            signupBtn.addEventListener('click', async () => {
                setAuthMessage('');
                const email = emailInput.value;
                const password = passwordInput.value;
                if (!email || !password) return setAuthMessage("Please enter email and password.");
                if (password.length < 6) return setAuthMessage("Password must be at least 6 characters.");

                setButtonState(signupBtn, true);
                try {
                    await createUserWithEmailAndPassword(auth, email, password);
                } catch (error) { 
                    setAuthMessage(error.message);
                    setButtonState(signupBtn, false);
                }
            });

            signinBtn.addEventListener('click', async () => {
                setAuthMessage('');
                const email = emailInput.value;
                const password = passwordInput.value;
                if (!email || !password) return setAuthMessage("Please enter email and password.");

                setButtonState(signinBtn, true);
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) { 
                    setAuthMessage("Invalid email or password. Please try again.");
                    setButtonState(signinBtn, false);
                }
            });
            
            googleSigninBtn.addEventListener('click', async () => {
                setAuthMessage('');
                setButtonState(googleSigninBtn, true);
                try {
                    await signInWithPopup(auth, new GoogleAuthProvider());
                } catch (error) { 
                    setAuthMessage(error.message);
                    setButtonState(googleSigninBtn, false);
                }
            });

            forgotPasswordLink.addEventListener('click', async (e) => {
                e.preventDefault();
                setAuthMessage('');
                if (!emailInput.value) return setAuthMessage('Please enter your email to reset password.');
                try {
                    await sendPasswordResetEmail(auth, emailInput.value);
                    setAuthMessage('Password reset email sent! Check your inbox.', false);
                } catch (error) { setAuthMessage(error.message); }
            });

            offlineBtn.addEventListener('click', () => {
                isOfflineMode = true;
                currentUser = null;
                localStorage.setItem('pinkDaysOfflineMode', 'true');
                showAppScreen();
                loadDataFromLocalStorage();
                addOfflineExitButton();
            });

            // --- DATA MANAGEMENT ---
            async function loadDataFromFirestore() {
                const docRef = doc(db, 'users', currentUser.uid);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    periodData = (Array.isArray(data.periods) && typeof data.cycleLength === 'number') ? data : { periods: [], cycleLength: 28 };
                } else {
                    periodData = { periods: [], cycleLength: 28 };
                    app.welcomeModal.classList.remove('hidden');
                }
                initializeAppUI();
            }

            function loadDataFromLocalStorage() {
                const data = localStorage.getItem('pinkDaysData');
                if (data) {
                    try {
                        const parsedData = JSON.parse(data);
                        if (Array.isArray(parsedData.periods) && typeof parsedData.cycleLength === 'number') {
                            periodData = parsedData;
                        } else throw new Error("Invalid data structure");
                    } catch (e) {
                        localStorage.removeItem('pinkDaysData');
                        showConfirm("Data Error", "Your local data was corrupted and has been reset.", [{ text: "OK" }]);
                    }
                } else {
                    app.welcomeModal.classList.remove('hidden');
                }
                initializeAppUI();
            }

            async function saveData() {
                periodData.periods.sort((a, b) => a.date.localeCompare(b.date));
                try {
                    if (isOfflineMode) {
                        localStorage.setItem('pinkDaysData', JSON.stringify(periodData));
                    } else if (currentUser) {
                        await setDoc(doc(db, 'users', currentUser.uid), periodData);
                    }
                    updateAllUI();
                } catch (error) {
                    showConfirm("Save Error", "Could not save your data. Please check your connection.", [{ text: "OK" }]);
                }
            }
            
            function initializeAppUI() {
                periodData.periods.sort((a, b) => a.date.localeCompare(b.date));
                const lastTab = localStorage.getItem('pinkDaysLastTab') || 'stats';
                switchTab(lastTab);
                updateAllUI();
            }

            // --- ALL OTHER APP FUNCTIONS (UNCHANGED) ---
            function toISODateString(date) { var pad = function(num) { return (num < 10 ? '0' : '') + num; }; return date.getFullYear() + '-' + pad(date.getMonth() + 1) + '-' + pad(date.getDate()); }
            function fromISODateString(str) { return new Date(str + 'T00:00:00'); }
            function updateAllUI() { renderCalendar(); updateStats(); }
            function switchTab(tabName) { app.tabPanes.forEach(function(pane) { pane.classList.add('hidden'); }); document.getElementById(tabName + '-tab').classList.remove('hidden'); app.tabButtons.forEach(function(btn) { if (btn.dataset.tab === tabName) { btn.classList.add('active'); } else { btn.classList.remove('active'); } }); localStorage.setItem('pinkDaysLastTab', tabName); }
            function updateStats() { var startDates = getPeriodStartDates(); var calculatedAvgCycle = calculateAverageCycleLength(startDates); var effectiveCycleLength = periodData.cycleLength || calculatedAvgCycle; var avgPeriod = calculateAveragePeriodLength(); app.avgCycle.textContent = effectiveCycleLength + ' days'; app.avgPeriod.textContent = avgPeriod.toFixed(1) + ' days'; app.cycleOverrideInput.value = effectiveCycleLength; var nextDate = getNextPredictedStartDate(startDates, effectiveCycleLength); if (nextDate) { var today = new Date(); today.setHours(0, 0, 0, 0); var diffTime = nextDate - today; var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); if (diffDays === 0) app.countdown.textContent = "Today"; else if (diffDays < 0) app.countdown.textContent = "Overdue"; else app.countdown.textContent = diffDays + ' day' + (diffDays !== 1 ? 's' : ''); app.nextDate.textContent = '(' + nextDate.toLocaleDateString('default', { month: 'short', day: 'numeric' }) + ')'; } else { app.countdown.textContent = '--'; app.nextDate.textContent = 'Log a period to see predictions'; } renderHistory(startDates); renderFlowAnalysis(); renderNextFertileWindow(); }
            function renderHistory(startDates) { app.historyList.innerHTML = ''; if (startDates.length === 0) { app.historyList.innerHTML = '<li class="text-center text-gray-500">No periods logged yet.</li>'; return; } var periodBlocks = getPeriodBlocks(startDates); periodBlocks.reverse().slice(0, 5).forEach(function(block) { var startDate = fromISODateString(block.start); var endDate = fromISODateString(block.end); var li = document.createElement('li'); li.className = 'flex items-center space-x-2 bg-gray-50 p-3 rounded-lg'; li.innerHTML =  '<div>' + '<p class="font-semibold">' + startDate.toLocaleDateString('default', {month: 'long', day: 'numeric'}) + ' - ' + endDate.toLocaleDateString('default', {month: 'long', day: 'numeric', year: 'numeric'}) + '</p>' + '<p class="text-sm text-gray-500">' + block.length + ' days' + (block.cycleLength ? ' (' + block.cycleLength + '-day cycle)' : '') + '</p>' + '</div>'; app.historyList.appendChild(li); }); }
            function renderFlowAnalysis() { var flowDist = calculateFlowDistribution(); if (flowDist.totalDays === 0) { app.flowAnalysis.innerHTML = '<p class="text-center text-gray-500">Log periods to see flow analysis.</p>'; return; } app.flowAnalysis.innerHTML =  `<div class="space-y-3"> <div class="flex items-center text-sm text-gray-600"> <span class="font-semibold flex-grow-0 w-20">Light:</span> <div class="flex-1 h-4 bg-gray-200 rounded-full overflow-hidden mx-2"> <div class="h-full bg-pink-300" style="width: ${(flowDist.light / flowDist.totalDays) * 100}%;"></div> </div> <span class="w-16 text-right flex-grow-0">${flowDist.light.toFixed(1)} days</span> </div> <div class="flex items-center text-sm text-gray-600"> <span class="font-semibold flex-grow-0 w-20">Medium:</span> <div class="flex-1 h-4 bg-gray-200 rounded-full overflow-hidden mx-2"> <div class="h-full bg-pink-400" style="width: ${(flowDist.medium / flowDist.totalDays) * 100}%;"></div> </div> <span class="w-16 text-right flex-grow-0">${flowDist.medium.toFixed(1)} days</span> </div> <div class="flex items-center text-sm text-gray-600"> <span class="font-semibold flex-grow-0 w-20">Heavy:</span> <div class="flex-1 h-4 bg-gray-200 rounded-full overflow-hidden mx-2"> <div class="h-full bg-pink-500" style="width: ${(flowDist.heavy / flowDist.totalDays) * 100}%;"></div> </div> <span class="w-16 text-right flex-grow-0">${flowDist.heavy.toFixed(1)} days</span> </div> </div>`; }
            function renderNextFertileWindow() { var window = getNextFertileWindow(); if (window) { var start = fromISODateString(window.start); var end = fromISODateString(window.end); app.nextFertileWindow.innerHTML = `<span class="text-3xl">${start.toLocaleDateString('default', {month: 'short', day: 'numeric'})}</span> - <span class="text-3xl">${end.toLocaleDateString('default', {month: 'short', day: 'numeric'})}</span>`; } else { app.nextFertileWindow.textContent = '--'; } }
            function renderCalendar() { app.calendarGrid.innerHTML = ''; var year = currentDate.getFullYear(); var month = currentDate.getMonth(); app.monthYear.textContent = currentDate.toLocaleString('default', { month: 'long' }) + ' ' + year; var firstDayOfMonth = new Date(year, month, 1); var lastDayOfMonth = new Date(year, month + 1, 0); for (var i = 0; i < firstDayOfMonth.getDay(); i++) { var emptyDiv = document.createElement('div'); emptyDiv.className = 'day disabled'; app.calendarGrid.appendChild(emptyDiv); } var todayStr = toISODateString(new Date()); var predictedDates = getPredictedDates(); var fertileDates = getAllFertileDates(); for (var i = 1; i <= lastDayOfMonth.getDate(); i++) { var dayDate = new Date(year, month, i); var dayStr = toISODateString(dayDate); var classes = 'day cursor-pointer'; var periodDay = periodData.periods.find(function(p) { return p.date === dayStr; }); if (periodDay) { classes += ' flow-' + periodDay.flow; } else if (fertileDates.indexOf(dayStr) !== -1) { classes += ' fertile-day'; } else if (predictedDates.indexOf(dayStr) !== -1) { classes += ' predicted-day'; } if (dayStr === todayStr) classes += ' today'; if (dayDate.getDay() === 0) classes += ' sunday-text'; var dayEl = document.createElement('div'); dayEl.textContent = i; dayEl.className = classes; dayEl.addEventListener('click', (function(dateStr) { return function() { var block = findPeriodBlockForDate(dateStr); showLogPeriodModal(block ? block.start : dateStr, block ? block.end : dateStr); }; })(dayStr)); app.calendarGrid.appendChild(dayEl); } }
            function openMonthPicker() { pickerYear = currentDate.getFullYear(); app.monthPickerModal.classList.remove('hidden'); renderMonthGrid(); }
            function renderMonthGrid() { app.monthGrid.innerHTML = ''; app.pickerYearDisplay.textContent = pickerYear; var monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"]; for (var i = 0; i < 12; i++) { var monthBtn = document.createElement('button'); monthBtn.textContent = monthNames[i]; monthBtn.className = 'month-picker-btn'; if (i === currentDate.getMonth() && pickerYear === currentDate.getFullYear()) { monthBtn.classList.add('active'); } monthBtn.addEventListener('click', (function(monthIndex) { return function() { currentDate.setFullYear(pickerYear); currentDate.setMonth(monthIndex); renderCalendar(); app.monthPickerModal.classList.add('hidden'); }; })(i)); app.monthGrid.appendChild(monthBtn); } }
            function getPeriodStartDates() { var cycleStarts = []; if (periodData.periods.length === 0) return []; cycleStarts.push(periodData.periods[0].date); for (var i = 1; i < periodData.periods.length; i++) { var prevDate = fromISODateString(periodData.periods[i - 1].date); var currDate = fromISODateString(periodData.periods[i].date); var diffDays = (currDate - prevDate) / (1000 * 60 * 60 * 24); if (diffDays > 1) cycleStarts.push(periodData.periods[i].date); } return cycleStarts.filter(function(value, index, self) { return self.indexOf(value) === index; }); }
            function getPeriodBlocks(startDates) { return startDates.map(function(start, i) { var endDate = start; var length = 1; var currentDate = fromISODateString(start); while(true) { var nextDay = new Date(currentDate); nextDay.setDate(nextDay.getDate() + 1); var nextDayStr = toISODateString(nextDay); if (periodData.periods.find(function(p) { return p.date === nextDayStr; })) { endDate = nextDayStr; length++; currentDate = nextDay; } else { break; } } var cycleLength = i > 0 ? (fromISODateString(start) - fromISODateString(startDates[i-1])) / (1000 * 60 * 60 * 24) : null; return { start: start, end: endDate, length: length, cycleLength: cycleLength }; }); }
            function findPeriodBlockForDate(dateStr) { if (!periodData.periods.find(function(p) { return p.date === dateStr; })) return null; var blocks = getPeriodBlocks(getPeriodStartDates()); return blocks.find(function(b) { return dateStr >= b.start && dateStr <= b.end; }); }
            function calculateAverageCycleLength(startDates) { if (startDates.length < 2) return periodData.cycleLength || 28; var totalDiff = 0; for (var i = 1; i < startDates.length; i++) { totalDiff += (fromISODateString(startDates[i]) - fromISODateString(startDates[i-1])); } var avg = Math.round(totalDiff / (1000 * 60 * 60 * 24) / (startDates.length - 1)); return avg > 10 ? avg : (periodData.cycleLength || 28); }
            function calculateAveragePeriodLength() { var blocks = getPeriodBlocks(getPeriodStartDates()); if (blocks.length === 0) return 0; var totalLength = blocks.reduce(function(sum, b) { return sum + b.length; }, 0); return totalLength / blocks.length; }
            function calculateFlowDistribution() { var blocks = getPeriodBlocks(getPeriodStartDates()); if (blocks.length === 0) return { light: 0, medium: 0, heavy: 0, totalDays: 0 }; var counts = { light: 0, medium: 0, heavy: 0 }; periodData.periods.forEach(function(p) { if (counts.hasOwnProperty(p.flow)) { counts[p.flow]++; } }); return { light: counts.light / blocks.length, medium: counts.medium / blocks.length, heavy: counts.heavy / blocks.length, totalDays: periodData.periods.length }; }
            function getNextPredictedStartDate(startDates, cycleLen) { if (startDates.length === 0) return null; var lastStartDate = fromISODateString(startDates[startDates.length - 1]); lastStartDate.setDate(lastStartDate.getDate() + cycleLen); return lastStartDate; }
            function getPredictedDates() { var nextStartDate = getNextPredictedStartDate(getPeriodStartDates(), periodData.cycleLength); if (!nextStartDate) return []; var dates = []; var avgPeriodLength = Math.round(calculateAveragePeriodLength()) || 5; for (var i = 0; i < avgPeriodLength; i++) { var date = new Date(nextStartDate); date.setDate(date.getDate() + i); dates.push(toISODateString(date)); } return dates; }
            function getNextFertileWindow() { var nextStartDate = getNextPredictedStartDate(getPeriodStartDates(), periodData.cycleLength); if (!nextStartDate) return null; var ovulationDay = new Date(nextStartDate); ovulationDay.setDate(ovulationDay.getDate() - 14); var windowStart = new Date(ovulationDay); windowStart.setDate(windowStart.getDate() - 5); return { start: toISODateString(windowStart), end: toISODateString(ovulationDay) }; }
            function getAllFertileDates() { var startDates = getPeriodStartDates(); var fertileDatesSet = []; function addWindow(cycleEndDate) { if (!cycleEndDate) return; var ovulationDay = new Date(cycleEndDate); ovulationDay.setDate(ovulationDay.getDate() - 14); for (var i = 5; i >= 0; i--) { var date = new Date(ovulationDay); date.setDate(date.getDate() - i); var dateStr = toISODateString(date); if (fertileDatesSet.indexOf(dateStr) === -1) { fertileDatesSet.push(dateStr); } } } if (startDates.length >= 1) { for (var i = 1; i < startDates.length; i++) { addWindow(fromISODateString(startDates[i])); } } addWindow(getNextPredictedStartDate(startDates, periodData.cycleLength)); return fertileDatesSet; }
            function showLogPeriodModal(start, end) { app.startDateInput.value = start; app.endDateInput.value = end; updateDailyFlowSelectors(); app.logModal.classList.remove('hidden'); }
            function updateDailyFlowSelectors() { app.dailyFlowContainer.innerHTML = ''; var start = fromISODateString(app.startDateInput.value); var end = fromISODateString(app.endDateInput.value); if (!app.startDateInput.value || !app.endDateInput.value || start > end) return; var current = new Date(start); while(current <= end) { var dayStr = toISODateString(current); var existingLog = periodData.periods.find(function(p) { return p.date === dayStr; }); var flow = existingLog ? existingLog.flow : 'medium'; var dayEl = document.createElement('div'); dayEl.className = 'flex justify-between items-center bg-white p-2 rounded'; dayEl.innerHTML =  '<span class="text-sm font-medium">' + current.toLocaleDateString('default', {weekday: 'short', month: 'short', day: 'numeric'}) + '</span>' + '<div class="flex gap-1 items-center" data-date="' + dayStr + '">' + '<button data-flow="light" class="px-3 py-1 text-xs rounded ' + (flow === 'light' ? 'flow-light' : 'bg-gray-200') + '">Light</button>' + '<button data-flow="medium" class="px-3 py-1 text-xs rounded ' + (flow === 'medium' ? 'flow-medium' : 'bg-gray-200') + '">Medium</button>' + '<button data-flow="heavy" class="px-3 py-1 text-xs rounded ' + (flow === 'heavy' ? 'flow-heavy' : 'bg-gray-200') + '">Heavy</button>' + '<button data-action="delete" class="ml-2 text-gray-400 hover:text-red-500"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg></button>' + '</div>'; app.dailyFlowContainer.appendChild(dayEl); current.setDate(current.getDate() + 1); } }
            function showConfirm(title, message, options) { app.confirmTitle.textContent = title; app.confirmMessage.textContent = message; app.confirmOptions.innerHTML = ''; options.forEach(function(option) { var btn = document.createElement('button'); btn.textContent = option.text; var style = option.style || 'main-gradient-box'; if (style === 'cancel') { btn.className = 'w-full bg-gray-200 text-gray-800 font-bold py-3 px-6 rounded-lg hover:bg-gray-300'; } else if (style === 'bg-red-600') { btn.className = 'w-full bg-red-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-red-700 transition-colors'; } else { btn.className = 'w-full text-white font-bold py-3 px-6 rounded-lg shadow-md hover:opacity-90 transition-opacity ' + style; } btn.onclick = function() { if (option.action) option.action(); app.confirmModal.classList.add('hidden'); }; app.confirmOptions.appendChild(btn); }); app.confirmModal.classList.remove('hidden'); }
            app.tabButtons.forEach(function(btn) { btn.addEventListener('click', function() { switchTab(btn.dataset.tab); }); });
            app.prevBtn.addEventListener('click', function() { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
            app.nextBtn.addEventListener('click', function() { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
            app.monthYear.addEventListener('click', openMonthPicker);
            app.prevYearBtn.addEventListener('click', function() { pickerYear--; renderMonthGrid(); });
            app.nextYearBtn.addEventListener('click', function() { pickerYear++; renderMonthGrid(); });
            app.closeMonthPickerBtn.addEventListener('click', function() { app.monthPickerModal.classList.add('hidden'); });
            app.logPeriodBtn.addEventListener('click', function() { var today = toISODateString(new Date()); showLogPeriodModal(today, today); });
            app.closeWelcomeBtn.addEventListener('click', function() { app.welcomeModal.classList.add('hidden'); });
            app.showAnalysisBtn.addEventListener('click', function() { app.detailedAnalysis.classList.toggle('hidden'); if (app.detailedAnalysis.classList.contains('hidden')) { app.analysisArrow.textContent = '+'; } else { app.analysisArrow.textContent = '−'; } });
            app.startDateInput.addEventListener('change', updateDailyFlowSelectors); app.endDateInput.addEventListener('change', updateDailyFlowSelectors);
            app.dailyFlowContainer.addEventListener('click', function(e) { if (e.target.tagName === 'BUTTON' || e.target.closest('button')) { var button = e.target.closest('button'); if (button.dataset.action === 'delete') { var row = button.closest('.flex[data-date]'); var dateToDelete = row.dataset.date; periodData.periods = periodData.periods.filter(p => p.date !== dateToDelete); row.remove(); } else if (button.dataset.flow) { var buttons = button.parentElement.querySelectorAll('button[data-flow]'); buttons.forEach(function(b) { b.classList.remove('flow-light', 'flow-medium', 'flow-heavy'); b.classList.add('bg-gray-200'); }); button.classList.remove('bg-gray-200'); button.classList.add('flow-' + button.dataset.flow); } } });
            app.saveLogBtn.addEventListener('click', function() { var start = app.startDateInput.value; var end = app.endDateInput.value; if (!start || !end || fromISODateString(start) > fromISODateString(end)) { showConfirm("Invalid Dates", "Please ensure the start date is not after the end date.", [{text: "OK"}]); return; } periodData.periods = periodData.periods.filter(function(p) { return p.date < start || p.date > end; }); var flowRows = app.dailyFlowContainer.querySelectorAll('[data-date]'); flowRows.forEach(function(row) { var date = row.dataset.date; var selectedBtn = row.querySelector('button[class*="flow-"]'); if(selectedBtn) { var flow = selectedBtn.dataset.flow; periodData.periods.push({date: date, flow: flow}); } }); saveData(); app.logModal.classList.add('hidden'); });
            app.cancelLogBtn.addEventListener('click', function() { app.logModal.classList.add('hidden'); });
            app.saveCycleOverrideBtn.addEventListener('click', function() { var val = parseInt(app.cycleOverrideInput.value); if (val > 10) { periodData.cycleLength = val; saveData(); showConfirm("Success", "Cycle length has been updated.", [{text: "OK"}]); } else { showConfirm("Invalid Input", "Please enter a cycle length greater than 10 days.", [{text: "OK"}]); } });
            app.recalculateBtn.addEventListener('click', function() { var avg = calculateAverageCycleLength(getPeriodStartDates()); periodData.cycleLength = avg; app.cycleOverrideInput.value = avg; saveData(); showConfirm("Success", "Cycle length has been recalculated to " + avg + " days.", [{text: "OK"}]); });
            app.exportBtn.addEventListener('click', function() { var dataStr = JSON.stringify(periodData, null, 2); var blob = new Blob([dataStr], {type: "application/json"}); var url = URL.createObjectURL(blob); var a = document.createElement('a'); a.href = url; a.download = 'pinkdays_backup_' + new Date().toISOString().split('T')[0] + '.json'; document.body.appendChild(a); a.click(); setTimeout(function() { window.URL.revokeObjectURL(url); document.body.removeChild(a); }, 500); });
            app.importBtn.addEventListener('click', function() { app.uploadInput.click(); });
            app.uploadInput.addEventListener('change', function(e) { var file = e.target.files[0]; if (!file) return; var reader = new FileReader(); reader.onload = function(event) { try { var uploadedData = JSON.parse(event.target.result); if (!uploadedData.periods || !uploadedData.hasOwnProperty('cycleLength')) { throw new Error("Invalid file format"); } var newPeriods = {}; periodData.periods.forEach(function(p) { newPeriods[p.date] = p; }); uploadedData.periods.forEach(function(p) { newPeriods[p.date] = p; }); periodData.periods = Object.values ? Object.values(newPeriods) : Object.keys(newPeriods).map(function(key) { return newPeriods[key]; }); periodData.cycleLength = uploadedData.cycleLength; saveData(); showConfirm("Success", "Data has been merged.", [{text: "OK"}]); } catch (err) { showConfirm("Upload Error", "The selected file is not a valid PinkDays backup.", [{text: "OK"}]); } }; reader.readAsText(file); e.target.value = ''; });
            app.resetBtn.addEventListener('click', function() { showConfirm("Reset All Data?", "This action cannot be undone and will delete all your cycle history.", [ { text: "Cancel", style: 'cancel' }, { text: "Yes, Reset", action: function() { if (isOfflineMode) localStorage.removeItem('pinkDaysData'); periodData = { periods: [], cycleLength: 28 }; saveData(); }, style: 'bg-red-600' } ]); });

            // Initialize the app on load
            initializeApp();
        });
    </script>
    <script>
        // Register the Service Worker for PWA offline functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }
    </script>
</body>
</html>
