<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PinkDays</title>
    
    <!-- Web App Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Apple-specific meta tags for Add to Homescreen -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PinkDays">

    <!-- Add to Homescreen & Favicon Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="pinkdays_logo.png">
    <link rel="icon" type="image/png" sizes="32x32" href="pinkdays_logo.png">
    <link rel="icon" type="image/png" sizes="16x16" href="pinkdays_logo.png">
    <link rel="shortcut icon" href="pinkdays_logo.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        .main-gradient-text {
            background: -webkit-linear-gradient(45deg, #ff5c7c,#ff8ca6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .main-gradient-bg {
            background: linear-gradient(to right, #ff8ca6, #ff5c7c);
        }
        .main-gradient-box {
            background: linear-gradient(to right, #ff5c7c, #fa4366);
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .day {
            transition: all 0.2s ease-in-out;
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        .flow-light { 
            background-color: #ffb8c9; 
            color: #9d174d; 
        }
        .flow-medium { 
            background-color: #ff8ca6; 
            color: #fff; 
        }
        .flow-heavy { 
            background-color: #ff5c7c; 
            color: #fff; 
        }
        .predicted-day {
            background-color: #fff0f3;
            border: 1px dashed #ffb8c9; 
        }
        .fertile-day {
            background-color: #cffafe;
            color: #164e63;
        }
        .day.today {
            font-weight: bold;
            color: #1f2937; /* Black bold text */
            box-shadow: 0 0 0 2px #ff8ca6;
        }
        .day:not(.disabled):hover {
            background-color: #e5e7eb;
        }
        .disabled {
            color: #9ca3af;
        }
        .sunday-text {
            color: #ef4444;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            transition: opacity 0.2s ease-in-out;
        }
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .tab-btn.active {
            background-color: #ff5c7c;
            color: white;
        }
        .hidden {
            display: none !important;
        }
        .month-picker-btn {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.15s;
        }
        .month-picker-btn:hover {
            background-color: #f3f4f6;
        }
        .month-picker-btn.active {
            background-color: #ff5c7c;
            color: white;
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="app-container" class="max-w-xl mx-auto p-4">
        <header class="text-center my-6 flex justify-center items-center gap-3">
            <img src="pinkdays_transparentlogo.png" alt="PinkDays Logo" class="w-12 h-12" onerror="this.style.display='none'">
            <h1 class="text-4xl font-bold main-gradient-text">PinkDays</h1>
        </header>

        <nav class="flex justify-center bg-gray-200 rounded-lg p-1 mb-6">
            <button data-tab="stats" class="tab-btn flex-1 py-2 px-4 rounded-lg font-semibold transition-colors active">Stats</button>
            <button data-tab="calendar" class="tab-btn flex-1 py-2 px-4 rounded-lg font-semibold transition-colors">Calendar</button>
            <button data-tab="settings" class="tab-btn flex-1 py-2 px-4 rounded-lg font-semibold transition-colors">Settings</button>
        </nav>

        <div id="tab-content">
            <!-- Stats Tab -->
            <div id="stats-tab" class="tab-pane space-y-6">
                <section class="main-gradient-box text-white p-6 rounded-2xl shadow-lg text-center">
                    <h3 class="text-lg font-semibold mb-2 opacity-90">Period In</h3>
                    <p id="next-period-countdown" class="text-5xl font-bold">--</p>
                    <p id="next-period-date" class="text-sm opacity-80 h-5"></p>
                </section>
                <section class="bg-white p-6 rounded-2xl shadow-lg text-center">
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">Next Fertile Window</h3>
                    <p id="next-fertile-window" class="text-xl font-bold main-gradient-text">--</p>
                </section>
                <section class="bg-white p-6 rounded-2xl shadow-lg">
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div>
                            <p class="text-gray-600">Avg. Cycle Length</p>
                            <p id="avg-cycle-length" class="text-2xl font-bold main-gradient-text">--</p>
                        </div>
                        <div>
                            <p class="text-gray-600">Avg. Period Length</p>
                            <p id="avg-period-length" class="text-2xl font-bold main-gradient-text">--</p>
                        </div>
                    </div>
                </section>
                <section class="bg-white p-6 rounded-2xl shadow-lg">
                    <h3 class="text-lg font-semibold mb-4 text-center">Average Flow Analysis</h3>
                    <div id="flow-analysis" class="text-center text-gray-600">
                        </div>
                </section>
                <section class="bg-white p-6 rounded-2xl shadow-lg">
                    <h3 class="text-lg font-semibold mb-4 text-center">Period History</h3>
                    <ul id="period-history-list" class="space-y-3">
                        </ul>
                </section>
            </div>

            <!-- Calendar Tab -->
            <div id="calendar-tab" class="tab-pane hidden">
                <main class="bg-white p-6 rounded-2xl shadow-lg">
                    <div class="flex items-center justify-between mb-4">
                        <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-100">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <h2 id="month-year" class="text-xl font-semibold main-gradient-text cursor-pointer hover:underline"></h2>
                        <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-100">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="grid grid-cols-7 text-center font-medium text-gray-500 mb-2">
                        <div class="sunday-text">Sun</div>
                        <div>Mon</div>
                        <div>Tue</div>
                        <div>Wed</div>
                        <div>Thu</div>
                        <div>Fri</div>
                        <div>Sat</div>
                    </div>
                    <div id="calendar-grid" class="calendar-grid"></div>
                    <div class="mt-4 pt-4 border-t flex justify-center items-center gap-4 text-xs text-gray-600">
                        <div class="flex items-center">
                            <span class="legend-dot bg-pink-300"></span>Period
                        </div>
                        <div class="flex items-center">
                            <span class="legend-dot bg-cyan-200"></span>Fertile
                        </div>
                        <div class="flex items-center">
                            <span class="legend-dot predicted-day border border-pink-200"></span>Predicted
                        </div>
                    </div>
                    <div class="text-center mt-4 pt-4 border-t">
                        <button id="log-period-btn" class="w-full main-gradient-box text-white font-bold py-3 px-6 rounded-lg shadow-md hover:opacity-90 transition-opacity">Log New Period</button>
                    </div>
                </main>
            </div>

            <!-- Settings Tab (Overhauled) -->
            <div id="settings-tab" class="tab-pane hidden">
                <div class="space-y-6">
                    <section class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-xl font-semibold text-center mb-6">Backup & Restore</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <!-- Import Button -->
                            <div class="text-center">
                                <button id="import-data-btn" class="w-full flex items-center justify-center gap-2 bg-white text-pink-500 font-bold py-3 px-6 rounded-xl shadow-md border-2 border-pink-500 hover:bg-pink-50 transition-colors">
                                    <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                                    </svg>
                                    Import
                                </button>
                                <input type="file" id="upload-data-input" class="hidden" accept=".json">
                                <p class="text-xs text-gray-500 mt-1">Import a backup file to this device.</p>
                            </div>

                            <!-- Export Button -->
                            <div class="text-center">
                                <button id="export-data-btn" class="w-full flex items-center justify-center gap-2 main-gradient-box text-white font-bold py-3 px-6 rounded-xl shadow-md hover:opacity-90 transition-opacity">
                                    <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                                    </svg>
                                    Export
                                </button>
                                <p class="text-xs text-gray-500 mt-1">Export your data to a backup file.</p>
                            </div>
                        </div>
                    </section>
                    
                    <section class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-xl font-semibold text-center mb-6">Override Average Cycle Length (days)</h3>
                        <div class="space-y-4">
                            <!-- Manual Cycle Length Override -->
                            <div class="mb-4">
                                <div class="flex items-center space-x-2">
                                    <input type="number" id="cycle-length-input-settings" class="flex-1 p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-200 focus:border-pink-300 transition-colors" placeholder="e.g. 28">
                                    <button id="save-cycle-override-btn" class="px-6 py-3 main-gradient-box text-white font-semibold rounded-xl shadow-md hover:opacity-90 transition-opacity">Save</button>
                                </div>
                            </div>
                            <div class="flex justify-center">
                                <button id="recalculate-btn-settings" class="text-sm text-pink-600 hover:underline">Auto-calculate from history</button>
                            </div>
                        </div>
                    </section>

                    <!-- Reset Data Section -->
                    <section class="bg-white p-6 rounded-2xl shadow-lg text-center">
                        <div>
                            <button id="reset-data-btn" class="w-full bg-red-600 text-white font-bold py-3 px-6 rounded-xl shadow-md hover:bg-red-700 transition-colors">Reset All Data</button>
                            <p class="text-xs text-gray-500 mt-2">This action cannot be undone and will permanently delete all your data.</p>
                        </div>
                    </section>

                    <footer class="text-center pt-4 space-y-2">
                        <a href="mailto:arunthomas04042001@gmail.com" class="inline-flex items-center gap-2 text-sm text-pink-500 hover:text-pink-700 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                              <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                              <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                            </svg>
                            Reach out to the developer
                        </a>
                        <p class="text-gray-400 text-xs">Made with ‚ù§Ô∏è for all women</p>
                    </footer>
                </div>
            </div>
        </div>
    </div>

    <div id="welcome-modal" class="modal-backdrop hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-11/12 max-w-md text-center">
            <img src="pinkdays_transparentlogo.png" alt="PinkDays Logo" class="w-16 h-16 mx-auto mb-4" onerror="this.style.display='none'">
            <h2 class="text-2xl font-bold mb-4">Welcome to PinkDays!</h2>
            <p class="text-gray-600 mb-6">Here's a quick look at what you can do:</p>
            <ul class="text-left space-y-3 mb-8">
                <li class="flex items-center">
                    <span class="text-2xl mr-4">üóìÔ∏è</span>
                    <span>Track your period & flow on the <b>Calendar</b>.</span>
                </li>
                <li class="flex items-center">
                    <span class="text-2xl mr-4">üìà</span>
                    <span>View predictions & history in the <b>Stats</b> tab.</span>
                </li>
                <li class="flex items-center">
                    <span class="text-2xl mr-4">üîÆ</span>
                    <span>See your estimated <b>fertile window</b> automatically.</span>
                </li>
                <li class="flex items-center">
                    <span class="text-2xl mr-4">‚öôÔ∏è</span>
                    <span><b>Export</b> or <b>Import</b> your data in Settings.</span>
                </li>
            </ul>
            <button id="close-welcome-btn" class="w-full main-gradient-box text-white font-bold py-3 px-6 rounded-lg shadow-md hover:opacity-90 transition-opacity">
                Let's Get Started!
            </button>
        </div>
    </div>

    <div id="log-period-modal" class="modal-backdrop hidden">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-11/12 max-w-md">
            <h2 class="text-2xl font-bold mb-4 text-center main-gradient-text">Log Period</h2>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="start-date-input" class="block text-sm font-medium text-gray-700">Start Date</label>
                    <input type="date" id="start-date-input" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                    <label for="end-date-input" class="block text-sm font-medium text-gray-700">End Date</label>
                    <input type="date" id="end-date-input" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                </div>
            </div>
            <h3 class="text-md font-semibold text-center mb-2">Daily Flow</h3>
            <div id="daily-flow-container" class="space-y-2 mb-4 max-h-48 overflow-y-auto p-2 bg-gray-50 rounded-lg">
                </div>
            <div class="flex flex-col gap-2">
                <button id="save-log-btn" class="w-full main-gradient-box text-white font-bold py-3 px-6 rounded-lg shadow-md hover:opacity-90 transition-opacity">Save</button>
                <button id="cancel-log-btn" class="w-full bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">Cancel</button>
            </div>
        </div>
    </div>
    
    <div id="month-picker-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-xs">
            <div class="flex justify-between items-center mb-4">
                <button id="prev-year-btn" class="p-2 rounded-full hover:bg-gray-200" aria-label="Previous Year">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <h3 id="picker-year-display" class="text-lg font-semibold text-gray-800">2025</h3>
                <button id="next-year-btn" class="p-2 rounded-full hover:bg-gray-200" aria-label="Next Year">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
            <div id="month-grid" class="grid grid-cols-4 gap-2">
                </div>
            <div class="flex justify-end mt-4">
                <button id="close-month-picker-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Close</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="modal-backdrop hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-11/12 max-w-md text-center">
            <h2 id="confirm-title" class="text-2xl font-bold mb-2"></h2>
            <p id="confirm-message" class="text-gray-600 mb-6"></p>
            <div id="confirm-options-container" class="flex gap-4">
                </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM Elements ---
            var app = {
                // Tabs
                tabButtons: document.querySelectorAll('.tab-btn'),
                tabPanes: document.querySelectorAll('.tab-pane'),
                
                // Stats
                countdown: document.getElementById('next-period-countdown'),
                nextDate: document.getElementById('next-period-date'),
                nextFertileWindow: document.getElementById('next-fertile-window'),
                avgCycle: document.getElementById('avg-cycle-length'),
                avgPeriod: document.getElementById('avg-period-length'),
                flowAnalysis: document.getElementById('flow-analysis'),
                historyList: document.getElementById('period-history-list'),

                // Calendar
                calendarGrid: document.getElementById('calendar-grid'),
                monthYear: document.getElementById('month-year'),
                prevBtn: document.getElementById('prev-month-btn'),
                nextBtn: document.getElementById('next-month-btn'),
                logPeriodBtn: document.getElementById('log-period-btn'),

                // Settings
                cycleOverrideInput: document.getElementById('cycle-length-input-settings'),
                saveCycleOverrideBtn: document.getElementById('save-cycle-override-btn'),
                recalculateBtn: document.getElementById('recalculate-btn-settings'),
                exportBtn: document.getElementById('export-data-btn'),
                importBtn: document.getElementById('import-data-btn'),
                uploadInput: document.getElementById('upload-data-input'),
                resetBtn: document.getElementById('reset-data-btn'),

                // Modals
                welcomeModal: document.getElementById('welcome-modal'),
                closeWelcomeBtn: document.getElementById('close-welcome-btn'),
                logModal: document.getElementById('log-period-modal'),
                startDateInput: document.getElementById('start-date-input'),
                endDateInput: document.getElementById('end-date-input'),
                dailyFlowContainer: document.getElementById('daily-flow-container'),
                saveLogBtn: document.getElementById('save-log-btn'),
                cancelLogBtn: document.getElementById('cancel-log-btn'),
                
                monthPickerModal: document.getElementById('month-picker-modal'),
                prevYearBtn: document.getElementById('prev-year-btn'),
                nextYearBtn: document.getElementById('next-year-btn'),
                pickerYearDisplay: document.getElementById('picker-year-display'),
                monthGrid: document.getElementById('month-grid'),
                closeMonthPickerBtn: document.getElementById('close-month-picker-btn'),

                confirmModal: document.getElementById('confirm-modal'),
                confirmTitle: document.getElementById('confirm-title'),
                confirmMessage: document.getElementById('confirm-message'),
                confirmOptions: document.getElementById('confirm-options-container')
            };

            // --- State ---
            var currentDate = new Date();
            var pickerYear = new Date().getFullYear();
            var periodData = {
                periods: [], // [{date: 'YYYY-MM-DD', flow: 'light'}]
                cycleLength: 28
            };

            // --- Date Helpers ---
            function toISODateString(date) {
                var pad = function(num) { return (num < 10 ? '0' : '') + num; };
                return date.getFullYear() + '-' + pad(date.getMonth() + 1) + '-' + pad(date.getDate());
            }

            function fromISODateString(str) {
                return new Date(str + 'T00:00:00');
            }

            // --- Data Management ---
            function loadData() {
                var data = localStorage.getItem('pinkDaysData');
                if (data) {
                    try {
                        var parsedData = JSON.parse(data);
                        if (Array.isArray(parsedData.periods) && typeof parsedData.cycleLength === 'number') {
                            periodData = parsedData;
                            periodData.periods.sort(function(a, b) { return a.date.localeCompare(b.date); });
                        } else {
                            throw new Error("Invalid data structure");
                        }
                    } catch (e) {
                        console.error("Failed to load or parse data, resetting to default.", e);
                        localStorage.removeItem('pinkDaysData');
                        showConfirm("Data Error", "Your saved data was corrupted and has been reset.", [{ text: "OK" }]);
                    }
                } else {
                    app.welcomeModal.classList.remove('hidden');
                }
            }

            function saveData() {
                try {
                    periodData.periods.sort(function(a, b) { return a.date.localeCompare(b.date); });
                    localStorage.setItem('pinkDaysData', JSON.stringify(periodData));
                    updateAllUI();
                } catch (error) {
                    console.error("An error occurred while saving and updating the UI:", error);
                    showConfirm("An Error Occurred", "There was a problem updating the view. Please try refreshing the page.", [{text: "OK"}]);
                }
            }
            
            function updateAllUI() {
                renderCalendar();
                updateStats();
            }

            // --- Tabs ---
            function switchTab(tabName) {
                // Show/hide tab panes based on click
                app.tabPanes.forEach(function(pane) { pane.classList.add('hidden'); });
                document.getElementById(tabName + '-tab').classList.remove('hidden');
                app.tabButtons.forEach(function(btn) {
                    if (btn.dataset.tab === tabName) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            }

            // --- Stats ---
            function updateStats() {
                var startDates = getPeriodStartDates();
                var calculatedAvgCycle = calculateAverageCycleLength(startDates);
                var effectiveCycleLength = periodData.cycleLength || calculatedAvgCycle;
                var avgPeriod = calculateAveragePeriodLength();
                
                app.avgCycle.textContent = effectiveCycleLength + ' days';
                app.avgPeriod.textContent = avgPeriod.toFixed(1) + ' days';
                app.cycleOverrideInput.value = effectiveCycleLength;

                var nextDate = getNextPredictedStartDate(startDates, effectiveCycleLength);
                if (nextDate) {
                    var today = new Date();
                    today.setHours(0, 0, 0, 0);
                    var diffTime = nextDate - today;
                    var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    if (diffDays === 0) app.countdown.textContent = "Today";
                    else if (diffDays < 0) app.countdown.textContent = "Overdue";
                    else app.countdown.textContent = diffDays + ' day' + (diffDays !== 1 ? 's' : '');
                    
                    app.nextDate.textContent = '(' + nextDate.toLocaleDateString('default', { month: 'short', day: 'numeric' }) + ')';
                } else {
                    app.countdown.textContent = '--';
                    app.nextDate.textContent = 'Log a period to see predictions';
                }
                
                renderHistory(startDates);
                renderFlowAnalysis();
                renderNextFertileWindow();
            }

            function renderHistory(startDates) {
                app.historyList.innerHTML = '';
                if (startDates.length === 0) {
                    app.historyList.innerHTML = '<li class="text-center text-gray-500">No periods logged yet.</li>';
                    return;
                }
                var periodBlocks = getPeriodBlocks(startDates);
                periodBlocks.reverse().slice(0, 5).forEach(function(block) {
                    var startDate = fromISODateString(block.start);
                    var endDate = fromISODateString(block.end);
                    var li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-lg';
                    li.innerHTML = 
                        '<div>' +
                            '<p class="font-semibold">' + startDate.toLocaleDateString('default', {month: 'long', day: 'numeric'}) + ' - ' + endDate.toLocaleDateString('default', {month: 'long', day: 'numeric', year: 'numeric'}) + '</p>' +
                            '<p class="text-sm text-gray-500">' + block.length + ' days</p>' +
                        '</div>' +
                        '<div class="text-sm font-medium text-gray-700">' + (block.cycleLength ? block.cycleLength + '-day cycle' : '') + '</div>';
                    app.historyList.appendChild(li);
                });
            }

            function renderFlowAnalysis() {
                var flowDist = calculateFlowDistribution();
                if (flowDist.totalDays === 0) {
                    app.flowAnalysis.innerHTML = '<p class="text-gray-500">Log periods to see flow analysis.</p>';
                    return;
                }
                app.flowAnalysis.innerHTML = 
                    '<div class="grid grid-cols-3 gap-2">' +
                        '<div><p class="font-semibold">Light</p><p>' + flowDist.light.toFixed(1) + ' days</p></div>' +
                        '<div><p class="font-semibold">Medium</p><p>' + flowDist.medium.toFixed(1) + ' days</p></div>' +
                        '<div><p class="font-semibold">Heavy</p><p>' + flowDist.heavy.toFixed(1) + ' days</p></div>' +
                    '</div>';
            }

            function renderNextFertileWindow() {
                var window = getNextFertileWindow();
                if (window) {
                    var start = fromISODateString(window.start);
                    var end = fromISODateString(window.end);
                    app.nextFertileWindow.textContent = start.toLocaleDateString('default', {month: 'short', day: 'numeric'}) + ' - ' + end.toLocaleDateString('default', {month: 'short', day: 'numeric'});
                } else {
                    app.nextFertileWindow.textContent = '--';
                }
            }

            // --- Calendar ---
            function renderCalendar() {
                app.calendarGrid.innerHTML = '';
                var year = currentDate.getFullYear();
                var month = currentDate.getMonth();
                app.monthYear.textContent = currentDate.toLocaleString('default', { month: 'long' }) + ' ' + year;

                var firstDayOfMonth = new Date(year, month, 1);
                var lastDayOfMonth = new Date(year, month + 1, 0);
                
                for (var i = 0; i < firstDayOfMonth.getDay(); i++) {
                    var emptyDiv = document.createElement('div');
                    emptyDiv.className = 'day disabled';
                    app.calendarGrid.appendChild(emptyDiv);
                }
                
                var todayStr = toISODateString(new Date());
                var predictedDates = getPredictedDates();
                var fertileDates = getAllFertileDates();

                for (var i = 1; i <= lastDayOfMonth.getDate(); i++) {
                    var dayDate = new Date(year, month, i);
                    var dayStr = toISODateString(dayDate);
                    var classes = 'day cursor-pointer';
                    
                    var periodDay = periodData.periods.find(function(p) { return p.date === dayStr; });
                    if (periodDay) {
                        classes += ' flow-' + periodDay.flow;
                    } else if (fertileDates.indexOf(dayStr) !== -1) {
                        classes += ' fertile-day';
                    } else if (predictedDates.indexOf(dayStr) !== -1) {
                        classes += ' predicted-day';
                    }
                    
                    if (dayStr === todayStr) classes += ' today';
                    if (dayDate.getDay() === 0) classes += ' sunday-text';
                    
                    var dayEl = document.createElement('div');
                    dayEl.textContent = i;
                    dayEl.className = classes;
                    dayEl.addEventListener('click', (function(dateStr) {
                        return function() {
                            var block = findPeriodBlockForDate(dateStr);
                            showLogPeriodModal(block ? block.start : dateStr, block ? block.end : dateStr);
                        };
                    })(dayStr));
                    app.calendarGrid.appendChild(dayEl);
                }
            }
            
            // --- Month Picker Logic ---
            function openMonthPicker() {
                pickerYear = currentDate.getFullYear();
                app.monthPickerModal.classList.remove('hidden');
                renderMonthGrid();
            }

            function renderMonthGrid() {
                app.monthGrid.innerHTML = '';
                app.pickerYearDisplay.textContent = pickerYear;
                var monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

                for (var i = 0; i < 12; i++) {
                    var monthBtn = document.createElement('button');
                    monthBtn.textContent = monthNames[i];
                    monthBtn.className = 'month-picker-btn';
                    if (i === currentDate.getMonth() && pickerYear === currentDate.getFullYear()) {
                        monthBtn.classList.add('active');
                    }
                    monthBtn.addEventListener('click', (function(monthIndex) {
                        return function() {
                            currentDate.setFullYear(pickerYear);
                            currentDate.setMonth(monthIndex);
                            renderCalendar();
                            app.monthPickerModal.classList.add('hidden');
                        };
                    })(i));
                    app.monthGrid.appendChild(monthBtn);
                }
            }

            // --- Prediction Logic ---
            function getPeriodStartDates() {
                var cycleStarts = [];
                if (periodData.periods.length === 0) return [];
                
                cycleStarts.push(periodData.periods[0].date);
                for (var i = 1; i < periodData.periods.length; i++) {
                    var prevDate = fromISODateString(periodData.periods[i - 1].date);
                    var currDate = fromISODateString(periodData.periods[i].date);
                    var diffDays = (currDate - prevDate) / (1000 * 60 * 60 * 24);
                    if (diffDays > 1) cycleStarts.push(periodData.periods[i].date);
                }
                return cycleStarts.filter(function(value, index, self) {
                    return self.indexOf(value) === index;
                });
            }

            function getPeriodBlocks(startDates) {
                return startDates.map(function(start, i) {
                    var endDate = start;
                    var length = 1;
                    var currentDate = fromISODateString(start);
                    
                    while(true) {
                        var nextDay = new Date(currentDate);
                        nextDay.setDate(nextDay.getDate() + 1);
                        var nextDayStr = toISODateString(nextDay);
                        if (periodData.periods.find(function(p) { return p.date === nextDayStr; })) {
                            endDate = nextDayStr;
                            length++;
                            currentDate = nextDay;
                        } else {
                            break;
                        }
                    }
                    var cycleLength = i > 0 ? (fromISODateString(start) - fromISODateString(startDates[i-1])) / (1000 * 60 * 60 * 24) : null;
                    return { start: start, end: endDate, length: length, cycleLength: cycleLength };
                });
            }
            
            function findPeriodBlockForDate(dateStr) {
                if (!periodData.periods.find(function(p) { return p.date === dateStr; })) return null;
                var blocks = getPeriodBlocks(getPeriodStartDates());
                return blocks.find(function(b) { return dateStr >= b.start && dateStr <= b.end; });
            }

            function calculateAverageCycleLength(startDates) {
                if (startDates.length < 2) return periodData.cycleLength || 28;
                var totalDiff = 0;
                for (var i = 1; i < startDates.length; i++) {
                    totalDiff += (fromISODateString(startDates[i]) - fromISODateString(startDates[i-1]));
                }
                var avg = Math.round(totalDiff / (1000 * 60 * 60 * 24) / (startDates.length - 1));
                return avg > 10 ? avg : (periodData.cycleLength || 28);
            }

            function calculateAveragePeriodLength() {
                var blocks = getPeriodBlocks(getPeriodStartDates());
                if (blocks.length === 0) return 0;
                var totalLength = blocks.reduce(function(sum, b) { return sum + b.length; }, 0);
                return totalLength / blocks.length;
            }

            function calculateFlowDistribution() {
                var blocks = getPeriodBlocks(getPeriodStartDates());
                if (blocks.length === 0) return { light: 0, medium: 0, heavy: 0, totalDays: 0 };
                var counts = { light: 0, medium: 0, heavy: 0 };
                periodData.periods.forEach(function(p) {
                    if (counts.hasOwnProperty(p.flow)) {
                        counts[p.flow]++;
                    }
                });
                return {
                    light: counts.light / blocks.length,
                    medium: counts.medium / blocks.length,
                    heavy: counts.heavy / blocks.length,
                    totalDays: periodData.periods.length
                };
            }

            function getNextPredictedStartDate(startDates, cycleLen) {
                if (startDates.length === 0) return null;
                var lastStartDate = fromISODateString(startDates[startDates.length - 1]);
                lastStartDate.setDate(lastStartDate.getDate() + cycleLen);
                return lastStartDate;
            }
            
            function getPredictedDates() {
                var nextStartDate = getNextPredictedStartDate(getPeriodStartDates(), periodData.cycleLength);
                if (!nextStartDate) return [];
                var dates = [];
                var avgPeriodLength = Math.round(calculateAveragePeriodLength()) || 5;
                for (var i = 0; i < avgPeriodLength; i++) {
                    var date = new Date(nextStartDate);
                    date.setDate(date.getDate() + i);
                    dates.push(toISODateString(date));
                }
                return dates;
            }

            function getNextFertileWindow() {
                var nextStartDate = getNextPredictedStartDate(getPeriodStartDates(), periodData.cycleLength);
                if (!nextStartDate) return null;
                var ovulationDay = new Date(nextStartDate);
                ovulationDay.setDate(ovulationDay.getDate() - 14);
                var windowStart = new Date(ovulationDay);
                windowStart.setDate(windowStart.getDate() - 5);
                return { start: toISODateString(windowStart), end: toISODateString(ovulationDay) };
            }

            function getAllFertileDates() {
                var startDates = getPeriodStartDates();
                var fertileDatesSet = [];
                
                function addWindow(cycleEndDate) {
                    if (!cycleEndDate) return;
                    var ovulationDay = new Date(cycleEndDate);
                    ovulationDay.setDate(ovulationDay.getDate() - 14);
                    for (var i = 5; i >= 0; i--) {
                        var date = new Date(ovulationDay);
                        date.setDate(date.getDate() - i);
                        var dateStr = toISODateString(date);
                        if (fertileDatesSet.indexOf(dateStr) === -1) {
                            fertileDatesSet.push(dateStr);
                        }
                    }
                }
                
                if (startDates.length >= 1) {
                    for (var i = 1; i < startDates.length; i++) {
                        addWindow(fromISODateString(startDates[i]));
                    }
                }
                addWindow(getNextPredictedStartDate(startDates, periodData.cycleLength));
                return fertileDatesSet;
            }
            
            // --- Modals ---
            function showLogPeriodModal(start, end) {
                app.startDateInput.value = start;
                app.endDateInput.value = end;
                updateDailyFlowSelectors();
                app.logModal.classList.remove('hidden');
            }
            
            function updateDailyFlowSelectors() {
                app.dailyFlowContainer.innerHTML = '';
                var start = fromISODateString(app.startDateInput.value);
                var end = fromISODateString(app.endDateInput.value);
                if (!app.startDateInput.value || !app.endDateInput.value || start > end) return;
                
                var current = new Date(start);
                while(current <= end) {
                    var dayStr = toISODateString(current);
                    var existingLog = periodData.periods.find(function(p) { return p.date === dayStr; });
                    var flow = existingLog ? existingLog.flow : 'medium';
                    
                    var dayEl = document.createElement('div');
                    dayEl.className = 'flex justify-between items-center bg-white p-2 rounded';
                    dayEl.innerHTML = 
                        '<span class="text-sm font-medium">' + current.toLocaleDateString('default', {weekday: 'short', month: 'short', day: 'numeric'}) + '</span>' +
                        '<div class="flex gap-1 items-center" data-date="' + dayStr + '">' +
                            '<button data-flow="light" class="px-3 py-1 text-xs rounded ' + (flow === 'light' ? 'flow-light' : 'bg-gray-200') + '">Light</button>' +
                            '<button data-flow="medium" class="px-3 py-1 text-xs rounded ' + (flow === 'medium' ? 'flow-medium' : 'bg-gray-200') + '">Medium</button>' +
                            '<button data-flow="heavy" class="px-3 py-1 text-xs rounded ' + (flow === 'heavy' ? 'flow-heavy' : 'bg-gray-200') + '">Heavy</button>' +
                            '<button data-action="delete" class="ml-2 text-gray-400 hover:text-red-500"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg></button>' +
                        '</div>';
                    app.dailyFlowContainer.appendChild(dayEl);
                    current.setDate(current.getDate() + 1);
                }
            }

            function showConfirm(title, message, options) {
                app.confirmTitle.textContent = title;
                app.confirmMessage.textContent = message;
                app.confirmOptions.innerHTML = '';
                options.forEach(function(option) {
                    var btn = document.createElement('button');
                    btn.textContent = option.text;
                    var style = option.style || 'main-gradient-box';
                    if (style === 'cancel') {
                        btn.className = 'w-full bg-gray-200 text-gray-800 font-bold py-3 px-6 rounded-lg hover:bg-gray-300';
                    } else if (style === 'bg-red-600') {
                        btn.className = 'w-full bg-red-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-red-700 transition-colors';
                    } else {
                        btn.className = 'w-full text-white font-bold py-3 px-6 rounded-lg shadow-md hover:opacity-90 transition-opacity ' + style;
                    }
                    btn.onclick = function() {
                        if (option.action) option.action();
                        app.confirmModal.classList.add('hidden');
                    };
                    app.confirmOptions.appendChild(btn);
                });
                app.confirmModal.classList.remove('hidden');
            }
            
            // --- Event Listeners ---
            app.tabButtons.forEach(function(btn) {
                btn.addEventListener('click', function() {
                    switchTab(btn.dataset.tab);
                });
            });

            app.prevBtn.addEventListener('click', function() {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
            });

            app.nextBtn.addEventListener('click', function() {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
            });

            app.monthYear.addEventListener('click', openMonthPicker);

            app.prevYearBtn.addEventListener('click', function() {
                pickerYear--;
                renderMonthGrid();
            });

            app.nextYearBtn.addEventListener('click', function() {
                pickerYear++;
                renderMonthGrid();
            });

            app.closeMonthPickerBtn.addEventListener('click', function() {
                app.monthPickerModal.classList.add('hidden');
            });

            app.logPeriodBtn.addEventListener('click', function() {
                var today = toISODateString(new Date());
                showLogPeriodModal(today, today);
            });
            
            app.closeWelcomeBtn.addEventListener('click', function() {
                app.welcomeModal.classList.add('hidden');
            });

            app.startDateInput.addEventListener('change', updateDailyFlowSelectors);
            app.endDateInput.addEventListener('change', updateDailyFlowSelectors);

            app.dailyFlowContainer.addEventListener('click', function(e) {
                if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                    var button = e.target.closest('button');
                    if (button.dataset.action === 'delete') {
                        var row = button.closest('.flex[data-date]');
                        var dateToDelete = row.dataset.date;
                        periodData.periods = periodData.periods.filter(p => p.date !== dateToDelete);
                        row.remove(); // Remove the row from the UI
                    } else if (button.dataset.flow) {
                        var buttons = button.parentElement.querySelectorAll('button[data-flow]');
                        buttons.forEach(function(b) {
                            b.classList.remove('flow-light', 'flow-medium', 'flow-heavy');
                            b.classList.add('bg-gray-200');
                        });
                        button.classList.remove('bg-gray-200');
                        button.classList.add('flow-' + button.dataset.flow);
                    }
                }
            });
            
            app.saveLogBtn.addEventListener('click', function() {
                var start = app.startDateInput.value;
                var end = app.endDateInput.value;
                if (!start || !end || fromISODateString(start) > fromISODateString(end)) {
                    showConfirm("Invalid Dates", "Please ensure the start date is not after the end date.", [{text: "OK"}]);
                    return;
                }
                
                periodData.periods = periodData.periods.filter(function(p) {
                    return p.date < start || p.date > end;
                });
                
                var flowRows = app.dailyFlowContainer.querySelectorAll('[data-date]');
                flowRows.forEach(function(row) {
                    var date = row.dataset.date;
                    var selectedBtn = row.querySelector('button[class*="flow-"]');
                    if(selectedBtn) {
                        var flow = selectedBtn.dataset.flow;
                        periodData.periods.push({date: date, flow: flow});
                    }
                });
                
                saveData();
                app.logModal.classList.add('hidden');
            });
            
            app.cancelLogBtn.addEventListener('click', function() {
                app.logModal.classList.add('hidden');
            });

            // Settings Listeners
            app.saveCycleOverrideBtn.addEventListener('click', function() {
                var val = parseInt(app.cycleOverrideInput.value);
                if (val > 10) {
                    periodData.cycleLength = val;
                    saveData();
                    showConfirm("Success", "Cycle length has been updated.", [{text: "OK"}]);
                } else {
                    showConfirm("Invalid Input", "Please enter a cycle length greater than 10 days.", [{text: "OK"}]);
                }
            });

            app.recalculateBtn.addEventListener('click', function() {
                 var avg = calculateAverageCycleLength(getPeriodStartDates());
                 periodData.cycleLength = avg;
                 app.cycleOverrideInput.value = avg;
                 saveData();
                 showConfirm("Success", "Cycle length has been recalculated to " + avg + " days.", [{text: "OK"}]);
            });

            app.exportBtn.addEventListener('click', function() {
                var dataStr = JSON.stringify(periodData, null, 2);
                var blob = new Blob([dataStr], {type: "application/json"});
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = 'pinkdays_backup_' + new Date().toISOString().split('T')[0] + '.json';
                a.click();
                URL.revokeObjectURL(url);
            });

            app.importBtn.addEventListener('click', function() {
                app.uploadInput.click();
            });

            app.uploadInput.addEventListener('change', function(e) {
                var file = e.target.files[0];
                if (!file) return;
                var reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        var uploadedData = JSON.parse(event.target.result);
                        if (!uploadedData.periods || !uploadedData.hasOwnProperty('cycleLength')) {
                            throw new Error("Invalid file format");
                        }
                        
                        var newPeriods = {};
                        periodData.periods.forEach(function(p) {
                            newPeriods[p.date] = p;
                        });
                        uploadedData.periods.forEach(function(p) {
                            newPeriods[p.date] = p;
                        });
                        periodData.periods = Object.values ? Object.values(newPeriods) : Object.keys(newPeriods).map(function(key) { return newPeriods[key]; });
                        periodData.cycleLength = uploadedData.cycleLength;
                        saveData();
                        showConfirm("Success", "Data has been merged.", [{text: "OK"}]);

                    } catch (err) {
                        showConfirm("Upload Error", "The selected file is not a valid PinkDays backup.", [{text: "OK"}]);
                    }
                };
                reader.readAsText(file);
                e.target.value = '';
            });

            app.resetBtn.addEventListener('click', function() {
                showConfirm("Reset All Data?", "This action cannot be undone and will delete all your cycle history.", [
                    { text: "Cancel", style: 'cancel' },
                    { 
                        text: "Yes, Reset", 
                        action: function() {
                            localStorage.removeItem('pinkDaysData');
                            periodData = { periods: [], cycleLength: 28 };
                            saveData();
                        }, 
                        style: 'bg-red-600'
                    }
                ]);
            });

            // --- INITIALIZATION ---
            loadData();
            switchTab('stats');
            updateAllUI();
        });
    </script>
</body>
</html>
