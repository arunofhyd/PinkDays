<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PinkDays</title>
    
    <!-- Add to Homescreen & Favicon Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="pinkdays_logo.png">
    <link rel="icon" type="image/png" sizes="32x32" href="pinkdays_logo.png">
    <link rel="icon" type="image/png" sizes="16x16" href="pinkdays_logo.png">
    <link rel="shortcut icon" href="pinkdays_logo.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb; /* gray-50 */
        }
        .main-gradient-text {
            color: #ff5c7c;
        }
        .main-gradient-bg {
            background: linear-gradient(to right, #ff8ca6, #ff5c7c);
        }
        .main-gradient-box {
            background: linear-gradient(to right, #ff5c7c, #fa4366);
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .day {
            transition: all 0.2s ease-in-out;
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        /* Flow intensity styles */
        .flow-light { background-color: #ffb8c9; color: #9d174d; }
        .flow-medium { background-color: #ff8ca6; color: #fff; }
        .flow-heavy { background-color: #ff5c7c; color: #fff; }
        
        .predicted-day {
            background-color: #fff0f3;
            border: 1px dashed #ffb8c9; 
        }
        .fertile-day {
            background-color: #cffafe;
            color: #164e63;
        }
        .day.today {
            font-weight: bold;
            color: #ff5c7c;
            box-shadow: 0 0 0 2px #ff8ca6;
        }
        .day:not(.disabled):hover {
            background-color: #e5e7eb;
        }
        .disabled {
            color: #9ca3af;
        }
        .sunday-text {
            color: #ef4444; /* red-500 */
        }
        /* Modal styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            transition: opacity 0.2s ease-in-out;
        }
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .tab-btn.active {
            background-color: #ff5c7c;
            color: white;
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="app-container" class="max-w-xl mx-auto p-4">
        <header class="text-center my-6 flex justify-center items-center gap-3">
            <img src="pinkdays_transparentlogo.png" alt="PinkDays Logo" class="w-12 h-12" onerror="this.style.display='none'">
            <h1 class="text-4xl font-bold main-gradient-text">PinkDays</h1>
        </header>

        <!-- Tab Navigation -->
        <nav class="flex justify-center bg-gray-200 rounded-lg p-1 mb-6">
            <button data-tab="stats" class="tab-btn flex-1 py-2 px-4 rounded-lg font-semibold transition-colors active">Stats</button>
            <button data-tab="calendar" class="tab-btn flex-1 py-2 px-4 rounded-lg font-semibold transition-colors">Calendar</button>
            <button data-tab="settings" class="tab-btn flex-1 py-2 px-4 rounded-lg font-semibold transition-colors">Settings</button>
        </nav>

        <!-- Tab Content -->
        <div id="tab-content">
            <!-- Stats Tab -->
            <div id="stats-tab" class="tab-pane space-y-6">
                <section class="main-gradient-box text-white p-6 rounded-2xl shadow-lg text-center">
                    <h3 class="text-lg font-semibold mb-2 opacity-90">Period In</h3>
                    <p id="next-period-countdown" class="text-5xl font-bold">--</p>
                    <p id="next-period-date" class="text-sm opacity-80 h-5"></p>
                </section>
                 <section class="bg-white p-6 rounded-2xl shadow-lg text-center">
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">Next Fertile Window</h3>
                    <p id="next-fertile-window" class="text-xl font-bold main-gradient-text">--</p>
                </section>
                <section class="bg-white p-6 rounded-2xl shadow-lg">
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div>
                            <p class="text-gray-600">Avg. Cycle Length</p>
                            <p id="avg-cycle-length" class="text-2xl font-bold main-gradient-text">--</p>
                        </div>
                        <div>
                            <p class="text-gray-600">Avg. Period Length</p>
                            <p id="avg-period-length" class="text-2xl font-bold main-gradient-text">--</p>
                        </div>
                    </div>
                </section>
                 <section class="bg-white p-6 rounded-2xl shadow-lg">
                    <h3 class="text-lg font-semibold mb-4 text-center">Average Flow Analysis</h3>
                    <div id="flow-analysis" class="text-center text-gray-600">
                        <!-- Flow analysis will be injected here -->
                    </div>
                </section>
                <section class="bg-white p-6 rounded-2xl shadow-lg">
                    <h3 class="text-lg font-semibold mb-4 text-center">Period History</h3>
                    <ul id="period-history-list" class="space-y-3">
                        <!-- History items will be injected here -->
                    </ul>
                </section>
            </div>

            <!-- Calendar Tab -->
            <div id="calendar-tab" class="tab-pane hidden">
                <main class="bg-white p-6 rounded-2xl shadow-lg">
                    <div class="flex items-center justify-between mb-4">
                        <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-100">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>
                        <h2 id="month-year" class="text-xl font-semibold"></h2>
                        <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-100">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                    <div class="grid grid-cols-7 text-center font-medium text-gray-500 mb-2">
                        <div class="sunday-text">Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                    </div>
                    <div id="calendar-grid" class="calendar-grid"></div>
                    <div class="mt-4 pt-4 border-t flex justify-center items-center gap-4 text-xs text-gray-600">
                        <div class="flex items-center"><span class="legend-dot bg-[#ff8ca6]"></span>Period</div>
                        <div class="flex items-center"><span class="legend-dot bg-cyan-200"></span>Fertile</div>
                        <div class="flex items-center"><span class="legend-dot predicted-day border-[#ffb8c9]"></span>Predicted</div>
                    </div>
                    <div class="text-center mt-4 pt-4 border-t">
                        <button id="log-period-btn" class="w-full main-gradient-box text-white font-bold py-3 px-6 rounded-lg shadow-md hover:opacity-90 transition-opacity">Log New Period</button>
                    </div>
                </main>
            </div>

            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-pane hidden">
                 <section class="bg-white p-6 rounded-2xl shadow-lg space-y-4">
                    <h3 class="text-xl font-semibold text-center mb-4">Settings</h3>
                    <div>
                        <label for="cycle-length-input-settings" class="block text-sm font-medium text-gray-700">Override Cycle Length (days)</label>
                        <div class="flex gap-2 mt-1">
                            <input type="number" id="cycle-length-input-settings" class="w-full p-2 border border-gray-300 rounded-lg">
                            <button id="save-cycle-override-btn" class="px-4 py-2 main-gradient-box text-white font-semibold rounded-lg hover:opacity-90">Save</button>
                        </div>
                         <button id="recalculate-btn-settings" class="text-sm text-[#ff5c7c] hover:underline mt-2">Auto-calculate from history</button>
                    </div>
                    <div class="pt-4 border-t">
                        <h4 class="font-semibold text-gray-800 mb-2">Data Management</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                             <button id="download-data-btn" class="w-full bg-[#ff8ca6] text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-[#ff5c7c] transition-colors">Download Data</button>
                             <button onClick="document.getElementById('upload-data-input').click()" class="w-full bg-[#ff8ca6] text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-[#ff5c7c] transition-colors">Upload Data</button>
                             <input type="file" id="upload-data-input" class="hidden" accept=".json">
                        </div>
                    </div>
                    <div class="pt-4 border-t">
                        <button id="reset-data-btn" class="w-full bg-red-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-red-700 transition-colors">Reset All Data</button>
                    </div>
                 </section>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="welcome-modal" class="modal-backdrop hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-11/12 max-w-md text-center">
            <img src="pinkdays_transparentlogo.png" alt="PinkDays Logo" class="w-16 h-16 mx-auto mb-4" onerror="this.style.display='none'">
            <h2 class="text-2xl font-bold mb-4">Welcome to PinkDays!</h2>
            <p class="text-gray-600 mb-6">Here's a quick look at what you can do:</p>
            <ul class="text-left space-y-3 mb-8">
                <li class="flex items-center">
                    <span class="text-2xl mr-4">🗓️</span>
                    <span>Track your period & flow on the <b>Calendar</b>.</span>
                </li>
                <li class="flex items-center">
                    <span class="text-2xl mr-4">📈</span>
                    <span>View predictions & history in the <b>Stats</b> tab.</span>
                </li>
                <li class="flex items-center">
                    <span class="text-2xl mr-4">🔮</span>
                    <span>See your estimated <b>fertile window</b> automatically.</span>
                </li>
                <li class="flex items-center">
                    <span class="text-2xl mr-4">⚙️</span>
                    <span><b>Download</b> or <b>Upload</b> your data in Settings.</span>
                </li>
            </ul>
            <button id="close-welcome-btn" class="w-full main-gradient-box text-white font-bold py-3 px-6 rounded-lg shadow-md hover:opacity-90 transition-opacity">
                Let's Get Started!
            </button>
        </div>
    </div>

    <div id="log-period-modal" class="modal-backdrop hidden">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-11/12 max-w-md">
            <h2 class="text-2xl font-bold mb-4 text-center">Log Period</h2>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="start-date-input" class="block text-sm font-medium text-gray-700">Start Date</label>
                    <input type="date" id="start-date-input" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                    <label for="end-date-input" class="block text-sm font-medium text-gray-700">End Date</label>
                    <input type="date" id="end-date-input" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                </div>
            </div>
            <h3 class="text-md font-semibold text-center mb-2">Daily Flow</h3>
            <div id="daily-flow-container" class="space-y-2 mb-4 max-h-48 overflow-y-auto p-2 bg-gray-50 rounded-lg">
                <!-- Daily flow selectors will be injected here -->
            </div>
            <div class="flex flex-col gap-2">
                 <button id="save-log-btn" class="w-full main-gradient-box text-white font-bold py-3 px-6 rounded-lg shadow-md hover:opacity-90 transition-opacity">Save Period</button>
                 <button id="cancel-log-btn" class="w-full bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">Cancel</button>
            </div>
        </div>
    </div>
    
    <div id="confirm-modal" class="modal-backdrop hidden">
         <div class="bg-white p-8 rounded-2xl shadow-2xl w-11/12 max-w-md text-center">
            <h2 id="confirm-title" class="text-2xl font-bold mb-2"></h2>
            <p id="confirm-message" class="text-gray-600 mb-6"></p>
            <div id="confirm-options-container" class="flex gap-4">
                <!-- Buttons will be injected here -->
            </div>
        </div>
    </div>

    <script type="module">
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const app = {
                // Tabs
                tabButtons: document.querySelectorAll('.tab-btn'),
                tabPanes: document.querySelectorAll('.tab-pane'),
                
                // Stats
                countdown: document.getElementById('next-period-countdown'),
                nextDate: document.getElementById('next-period-date'),
                nextFertileWindow: document.getElementById('next-fertile-window'),
                avgCycle: document.getElementById('avg-cycle-length'),
                avgPeriod: document.getElementById('avg-period-length'),
                flowAnalysis: document.getElementById('flow-analysis'),
                historyList: document.getElementById('period-history-list'),

                // Calendar
                calendarGrid: document.getElementById('calendar-grid'),
                monthYear: document.getElementById('month-year'),
                prevBtn: document.getElementById('prev-month-btn'),
                nextBtn: document.getElementById('next-month-btn'),
                logPeriodBtn: document.getElementById('log-period-btn'),

                // Settings
                cycleOverrideInput: document.getElementById('cycle-length-input-settings'),
                saveCycleOverrideBtn: document.getElementById('save-cycle-override-btn'),
                recalculateBtn: document.getElementById('recalculate-btn-settings'),
                downloadBtn: document.getElementById('download-data-btn'),
                uploadInput: document.getElementById('upload-data-input'),
                resetBtn: document.getElementById('reset-data-btn'),

                // Modals
                welcomeModal: document.getElementById('welcome-modal'),
                closeWelcomeBtn: document.getElementById('close-welcome-btn'),
                logModal: document.getElementById('log-period-modal'),
                startDateInput: document.getElementById('start-date-input'),
                endDateInput: document.getElementById('end-date-input'),
                dailyFlowContainer: document.getElementById('daily-flow-container'),
                saveLogBtn: document.getElementById('save-log-btn'),
                cancelLogBtn: document.getElementById('cancel-log-btn'),
                
                confirmModal: document.getElementById('confirm-modal'),
                confirmTitle: document.getElementById('confirm-title'),
                confirmMessage: document.getElementById('confirm-message'),
                confirmOptions: document.getElementById('confirm-options-container'),
            };

            // --- State ---
            let currentDate = new Date();
            let periodData = {
                periods: [], // [{date: 'YYYY-MM-DD', flow: 'light'}]
                cycleLength: 28,
            };

            // --- Date Helpers (Timezone Safe) ---
            const toISODateString = (date) => {
                const pad = (num) => (num < 10 ? '0' : '') + num;
                return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}`;
            }
            const fromISODateString = (str) => new Date(str + 'T00:00:00');

            // --- Data Management ---
            const loadData = () => {
                const data = localStorage.getItem('pinkDaysData');
                if (data) {
                    try {
                        const parsedData = JSON.parse(data);
                        if (Array.isArray(parsedData.periods) && typeof parsedData.cycleLength === 'number') {
                            periodData = parsedData;
                            periodData.periods.sort((a, b) => a.date.localeCompare(b.date));
                        } else {
                            throw new Error("Invalid data structure");
                        }
                    } catch (e) {
                        console.error("Failed to load or parse data, resetting to default.", e);
                        localStorage.removeItem('pinkDaysData');
                        showConfirm("Data Error", "Your saved data was corrupted and has been reset.", [{ text: "OK" }]);
                    }
                } else {
                    app.welcomeModal.classList.remove('hidden');
                }
            };

            const saveData = () => {
                try {
                    periodData.periods.sort((a, b) => a.date.localeCompare(b.date));
                    localStorage.setItem('pinkDaysData', JSON.stringify(periodData));
                    updateAllUI();
                } catch (error) {
                    console.error("An error occurred while saving and updating the UI:", error);
                    showConfirm("An Error Occurred", "There was a problem updating the view. Please try refreshing the page.", [{text: "OK"}]);
                }
            };
            
            const updateAllUI = () => {
                renderCalendar();
                updateStats();
            };

            // --- Tabs ---
            const switchTab = (tabName) => {
                app.tabPanes.forEach(pane => pane.classList.add('hidden'));
                document.getElementById(`${tabName}-tab`).classList.remove('hidden');
                app.tabButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tab === tabName);
                });
            };

            // --- Stats ---
            const updateStats = () => {
                const startDates = getPeriodStartDates();
                const calculatedAvgCycle = calculateAverageCycleLength(startDates);
                const effectiveCycleLength = periodData.cycleLength || calculatedAvgCycle;
                const avgPeriod = calculateAveragePeriodLength();
                
                app.avgCycle.textContent = `${effectiveCycleLength} days`;
                app.avgPeriod.textContent = `${avgPeriod.toFixed(1)} days`;
                app.cycleOverrideInput.value = effectiveCycleLength;

                const nextDate = getNextPredictedStartDate(startDates, effectiveCycleLength);
                if (nextDate) {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const diffTime = nextDate - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    if (diffDays === 0) app.countdown.textContent = "Today";
                    else if (diffDays < 0) app.countdown.textContent = "Overdue";
                    else app.countdown.textContent = `${diffDays} day${diffDays !== 1 ? 's' : ''}`;
                    
                    app.nextDate.textContent = `(${nextDate.toLocaleDateString('default', { month: 'short', day: 'numeric' })})`;
                } else {
                    app.countdown.textContent = '--';
                    app.nextDate.textContent = 'Log a period to see predictions';
                }
                
                renderHistory(startDates);
                renderFlowAnalysis();
                renderNextFertileWindow();
            };

            const renderHistory = (startDates) => {
                app.historyList.innerHTML = '';
                if (startDates.length === 0) {
                    app.historyList.innerHTML = `<li class="text-center text-gray-500">No periods logged yet.</li>`;
                    return;
                }
                const periodBlocks = getPeriodBlocks(startDates);
                periodBlocks.reverse().slice(0, 5).forEach(block => {
                    const startDate = fromISODateString(block.start);
                    const endDate = fromISODateString(block.end);
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-lg';
                    li.innerHTML = `
                        <div>
                            <p class="font-semibold">${startDate.toLocaleDateString('default', {month: 'long', day: 'numeric'})} - ${endDate.toLocaleDateString('default', {month: 'long', day: 'numeric', year: 'numeric'})}</p>
                            <p class="text-sm text-gray-500">${block.length} days</p>
                        </div>
                        <div class="text-sm font-medium text-gray-700">${block.cycleLength ? `${block.cycleLength}-day cycle` : ''}</div>
                    `;
                    app.historyList.appendChild(li);
                });
            };

            const renderFlowAnalysis = () => {
                const flowDist = calculateFlowDistribution();
                if (flowDist.totalDays === 0) {
                    app.flowAnalysis.innerHTML = `<p class="text-gray-500">Log periods to see flow analysis.</p>`;
                    return;
                }
                app.flowAnalysis.innerHTML = `
                    <div class="grid grid-cols-3 gap-2">
                        <div><p class="font-semibold">Light</p><p>${flowDist.light.toFixed(1)} days</p></div>
                        <div><p class="font-semibold">Medium</p><p>${flowDist.medium.toFixed(1)} days</p></div>
                        <div><p class="font-semibold">Heavy</p><p>${flowDist.heavy.toFixed(1)} days</p></div>
                    </div>
                `;
            };

            const renderNextFertileWindow = () => {
                const window = getNextFertileWindow();
                if (window) {
                    const start = fromISODateString(window.start);
                    const end = fromISODateString(window.end);
                    app.nextFertileWindow.textContent = `${start.toLocaleDateString('default', {month: 'short', day: 'numeric'})} - ${end.toLocaleDateString('default', {month: 'short', day: 'numeric'})}`;
                } else {
                    app.nextFertileWindow.textContent = '--';
                }
            };

            // --- Calendar ---
            const renderCalendar = () => {
                app.calendarGrid.innerHTML = '';
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                app.monthYear.textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;

                const firstDayOfMonth = new Date(year, month, 1);
                const lastDayOfMonth = new Date(year, month + 1, 0);
                
                for (let i = 0; i < firstDayOfMonth.getDay(); i++) {
                    app.calendarGrid.insertAdjacentHTML('beforeend', '<div class="day disabled"></div>');
                }
                
                const todayStr = toISODateString(new Date());
                const predictedDates = getPredictedDates();
                const fertileDates = getAllFertileDates();

                for (let i = 1; i <= lastDayOfMonth.getDate(); i++) {
                    const dayDate = new Date(year, month, i);
                    const dayStr = toISODateString(dayDate);
                    let classes = 'day cursor-pointer';
                    
                    const periodDay = periodData.periods.find(p => p.date === dayStr);
                    if (periodDay) classes += ` flow-${periodDay.flow}`;
                    else if (fertileDates.includes(dayStr)) classes += ' fertile-day';
                    else if (predictedDates.includes(dayStr)) classes += ' predicted-day';
                    
                    if (dayStr === todayStr) classes += ' today';
                    if (dayDate.getDay() === 0) classes += ' sunday-text';
                    
                    const dayEl = document.createElement('div');
                    dayEl.textContent = i;
                    dayEl.className = classes;
                    dayEl.addEventListener('click', () => {
                        const block = findPeriodBlockForDate(dayStr);
                        showLogPeriodModal(block ? block.start : dayStr, block ? block.end : dayStr);
                    });
                    app.calendarGrid.appendChild(dayEl);
                }
            };

            // --- Prediction Logic (Robust) ---
            const getPeriodStartDates = () => {
                const cycleStarts = [];
                if (periodData.periods.length === 0) return [];
                
                cycleStarts.push(periodData.periods[0].date);
                for (let i = 1; i < periodData.periods.length; i++) {
                    const prevDate = fromISODateString(periodData.periods[i - 1].date);
                    const currDate = fromISODateString(periodData.periods[i].date);
                    const diffDays = (currDate - prevDate) / (1000 * 60 * 60 * 24);
                    if (diffDays > 1) cycleStarts.push(periodData.periods[i].date);
                }
                return [...new Set(cycleStarts)];
            };

            const getPeriodBlocks = (startDates) => {
                return startDates.map((start, i) => {
                    let endDate = start;
                    let length = 1;
                    let currentDate = fromISODateString(start);
                    
                    while (true) {
                        const nextDay = new Date(currentDate);
                        nextDay.setDate(nextDay.getDate() + 1);
                        const nextDayStr = toISODateString(nextDay);
                        if (periodData.periods.find(p => p.date === nextDayStr)) {
                            endDate = nextDayStr;
                            length++;
                            currentDate = nextDay;
                        } else {
                            break;
                        }
                    }
                    const cycleLength = i > 0 ? (fromISODateString(start) - fromISODateString(startDates[i-1])) / (1000 * 60 * 60 * 24) : null;
                    return { start, end: endDate, length, cycleLength };
                });
            };
            
            const findPeriodBlockForDate = (dateStr) => {
                if (!periodData.periods.find(p => p.date === dateStr)) return null;
                const blocks = getPeriodBlocks(getPeriodStartDates());
                return blocks.find(b => dateStr >= b.start && dateStr <= b.end);
            };

            const calculateAverageCycleLength = (startDates) => {
                if (startDates.length < 2) return periodData.cycleLength || 28;
                let totalDiff = 0;
                for (let i = 1; i < startDates.length; i++) {
                    totalDiff += (fromISODateString(startDates[i]) - fromISODateString(startDates[i-1]));
                }
                const avg = Math.round(totalDiff / (1000 * 60 * 60 * 24) / (startDates.length - 1));
                return avg > 10 ? avg : (periodData.cycleLength || 28);
            };

            const calculateAveragePeriodLength = () => {
                const blocks = getPeriodBlocks(getPeriodStartDates());
                if (blocks.length === 0) return 0;
                const totalLength = blocks.reduce((sum, b) => sum + b.length, 0);
                return totalLength / blocks.length;
            };

            const calculateFlowDistribution = () => {
                const blocks = getPeriodBlocks(getPeriodStartDates());
                if (blocks.length === 0) return { light: 0, medium: 0, heavy: 0, totalDays: 0 };
                const counts = { light: 0, medium: 0, heavy: 0 };
                periodData.periods.forEach(p => {
                    if (counts.hasOwnProperty(p.flow)) {
                        counts[p.flow]++;
                    }
                });
                return {
                    light: counts.light / blocks.length,
                    medium: counts.medium / blocks.length,
                    heavy: counts.heavy / blocks.length,
                    totalDays: periodData.periods.length
                };
            };

            const getNextPredictedStartDate = (startDates, cycleLen) => {
                if (startDates.length === 0) return null;
                const lastStartDate = fromISODateString(startDates[startDates.length - 1]);
                lastStartDate.setDate(lastStartDate.getDate() + cycleLen);
                return lastStartDate;
            };
            
            const getPredictedDates = () => {
                const nextStartDate = getNextPredictedStartDate(getPeriodStartDates(), periodData.cycleLength);
                if (!nextStartDate) return [];
                const dates = [];
                for (let i = 0; i < Math.round(calculateAveragePeriodLength()) || 5; i++) {
                    const date = new Date(nextStartDate);
                    date.setDate(date.getDate() + i);
                    dates.push(toISODateString(date));
                }
                return dates;
            };

            const getNextFertileWindow = () => {
                const nextStartDate = getNextPredictedStartDate(getPeriodStartDates(), periodData.cycleLength);
                if (!nextStartDate) return null;
                const ovulationDay = new Date(nextStartDate);
                ovulationDay.setDate(ovulationDay.getDate() - 14);
                const windowStart = new Date(ovulationDay);
                windowStart.setDate(windowStart.getDate() - 5);
                return { start: toISODateString(windowStart), end: toISODateString(ovulationDay) };
            };

            const getAllFertileDates = () => {
                const startDates = getPeriodStartDates();
                const fertileDatesSet = new Set();
                const addWindow = (cycleEndDate) => {
                    if (!cycleEndDate) return;
                    const ovulationDay = new Date(cycleEndDate);
                    ovulationDay.setDate(ovulationDay.getDate() - 14);
                    for (let i = 5; i >= 0; i--) {
                        const date = new Date(ovulationDay);
                        date.setDate(date.getDate() - i);
                        fertileDatesSet.add(toISODateString(date));
                    }
                };
                if (startDates.length >= 1) {
                    for (let i = 1; i < startDates.length; i++) addWindow(fromISODateString(startDates[i]));
                }
                addWindow(getNextPredictedStartDate(startDates, periodData.cycleLength));
                return Array.from(fertileDatesSet);
            };
            
            // --- Modals ---
            const showLogPeriodModal = (start, end) => {
                app.startDateInput.value = start;
                app.endDateInput.value = end;
                updateDailyFlowSelectors();
                app.logModal.classList.remove('hidden');
            };
            
            const updateDailyFlowSelectors = () => {
                app.dailyFlowContainer.innerHTML = '';
                const start = fromISODateString(app.startDateInput.value);
                const end = fromISODateString(app.endDateInput.value);
                if (!app.startDateInput.value || !app.endDateInput.value || start > end) return;
                
                let current = new Date(start);
                while(current <= end) {
                    const dayStr = toISODateString(current);
                    const existingLog = periodData.periods.find(p => p.date === dayStr);
                    const flow = existingLog ? existingLog.flow : 'medium';
                    
                    const dayEl = document.createElement('div');
                    dayEl.className = 'flex justify-between items-center bg-white p-2 rounded';
                    dayEl.innerHTML = `
                        <span class="text-sm font-medium">${current.toLocaleDateString('default', {weekday: 'short', month: 'short', day: 'numeric'})}</span>
                        <div class="flex gap-1" data-date="${dayStr}">
                            <button data-flow="light" class="px-3 py-1 text-xs rounded ${flow === 'light' ? 'flow-light' : 'bg-gray-200'}">Light</button>
                            <button data-flow="medium" class="px-3 py-1 text-xs rounded ${flow === 'medium' ? 'flow-medium' : 'bg-gray-200'}">Medium</button>
                            <button data-flow="heavy" class="px-3 py-1 text-xs rounded ${flow === 'heavy' ? 'flow-heavy' : 'bg-gray-200'}">Heavy</button>
                        </div>
                    `;
                    app.dailyFlowContainer.appendChild(dayEl);
                    current.setDate(current.getDate() + 1);
                }
            };

            const showConfirm = (title, message, options) => {
                app.confirmTitle.textContent = title;
                app.confirmMessage.textContent = message;
                app.confirmOptions.innerHTML = '';
                options.forEach(({text, action, style = 'main-gradient-box'}) => {
                    const btn = document.createElement('button');
                    btn.textContent = text;
                    btn.className = `w-full text-white font-bold py-3 px-6 rounded-lg shadow-md hover:opacity-90 transition-opacity ${style}`;
                    if (style === 'cancel') btn.className = 'w-full bg-gray-200 text-gray-800 font-bold py-3 px-6 rounded-lg hover:bg-gray-300';
                    btn.onclick = () => {
                        if (action) action();
                        app.confirmModal.classList.add('hidden');
                    };
                    app.confirmOptions.appendChild(btn);
                });
                app.confirmModal.classList.remove('hidden');
            };
            
            // --- Event Listeners ---
            app.tabButtons.forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.tab)));
            app.prevBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
            app.nextBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
            app.logPeriodBtn.addEventListener('click', () => showLogPeriodModal(toISODateString(new Date()), toISODateString(new Date())));
            
            app.closeWelcomeBtn.addEventListener('click', () => app.welcomeModal.classList.add('hidden'));

            [app.startDateInput, app.endDateInput].forEach(input => input.addEventListener('change', updateDailyFlowSelectors));
            app.dailyFlowContainer.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    e.target.parentElement.querySelectorAll('button').forEach(b => {
                        b.classList.remove('flow-light', 'flow-medium', 'flow-heavy');
                        b.classList.add('bg-gray-200');
                    });
                    e.target.classList.remove('bg-gray-200');
                    e.target.classList.add(`flow-${e.target.dataset.flow}`);
                }
            });
            
            app.saveLogBtn.addEventListener('click', () => {
                const start = app.startDateInput.value;
                const end = app.endDateInput.value;
                if (!start || !end || fromISODateString(start) > fromISODateString(end)) {
                    showConfirm("Invalid Dates", "Please ensure the start date is not after the end date.", [{text: "OK"}]);
                    return;
                }
                periodData.periods = periodData.periods.filter(p => p.date < start || p.date > end);
                app.dailyFlowContainer.querySelectorAll('.flex[data-date]').forEach(row => {
                    const date = row.dataset.date;
                    const selectedBtn = row.querySelector('button[class*="flow-"]');
                    if(selectedBtn) {
                        const flow = selectedBtn.dataset.flow;
                        periodData.periods.push({date, flow});
                    }
                });
                saveData();
                app.logModal.classList.add('hidden');
            });
            
            app.cancelLogBtn.addEventListener('click', () => app.logModal.classList.add('hidden'));

            // Settings Listeners
            app.saveCycleOverrideBtn.addEventListener('click', () => {
                const val = parseInt(app.cycleOverrideInput.value);
                if (val > 10) {
                    periodData.cycleLength = val;
                    saveData();
                    showConfirm("Success", "Cycle length has been updated.", [{text: "OK"}]);
                } else {
                    showConfirm("Invalid Input", "Please enter a cycle length greater than 10 days.", [{text: "OK"}]);
                }
            });
            app.recalculateBtn.addEventListener('click', () => {
                 const avg = calculateAverageCycleLength(getPeriodStartDates());
                 periodData.cycleLength = avg;
                 app.cycleOverrideInput.value = avg;
                 saveData();
                 showConfirm("Success", `Cycle length has been recalculated to ${avg} days.`, [{text: "OK"}]);
            });
            app.downloadBtn.addEventListener('click', () => {
                const dataStr = JSON.stringify(periodData, null, 2);
                const blob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `pinkdays_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            });
            app.uploadInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const uploadedData = JSON.parse(event.target.result);
                        if (!uploadedData.periods || !uploadedData.hasOwnProperty('cycleLength')) throw new Error("Invalid file format");
                        
                        showConfirm("Upload Data", "How do you want to handle the uploaded data? Merging will keep your existing data and add/overwrite with new data.", [
                            { text: "Merge", action: () => {
                                const newPeriods = new Map(periodData.periods.map(p => [p.date, p]));
                                uploadedData.periods.forEach(p => newPeriods.set(p.date, p));
                                periodData.periods = Array.from(newPeriods.values());
                                periodData.cycleLength = uploadedData.cycleLength;
                                saveData();
                                showConfirm("Success", "Data has been merged.", [{text: "OK"}]);
                            }},
                            { text: "Overwrite", action: () => {
                                periodData = uploadedData;
                                saveData();
                                showConfirm("Success", "Data has been overwritten.", [{text: "OK"}]);
                            }},
                            { text: "Cancel", style: 'cancel' }
                        ]);

                    } catch (err) {
                        showConfirm("Upload Error", "The selected file is not a valid PinkDays backup.", [{text: "OK"}]);
                    }
                };
                reader.readAsText(file);
                e.target.value = '';
            });
            app.resetBtn.addEventListener('click', () => {
                showConfirm("Reset All Data?", "This action cannot be undone and will delete all your cycle history.", [
                    { text: "Cancel", style: 'cancel' },
                    { text: "Yes, Reset", action: () => {
                        localStorage.removeItem('pinkDaysData');
                        periodData = { periods: [], cycleLength: 28 };
                        saveData();
                    }, style: 'bg-red-600'}
                ]);
            });

            // --- INITIALIZATION ---
            loadData();
            switchTab('stats');
            updateAllUI();
        });
    </script>
</body>
</html>
